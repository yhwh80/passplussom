<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pass Plus SOM - Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Day.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      body { min-height: 100vh; }
      .active {
        background-color: #dcfce7;
        color: #166534;
        border-right: 2px solid #16a34a;
      }
      
      /* Mobile Responsive Styles */
      @media (max-width: 768px) {
        /* Calendar mobile optimization */
        #calendar-days-header {
          display: none;
        }
        
        #calendar-body {
          padding: 0;
        }
        
        .grid.grid-cols-8 {
          display: block;
        }
        
        /* Mobile calendar day view */
        .mobile-calendar-day {
          background: white;
          border-radius: 8px;
          margin-bottom: 16px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mobile-day-header {
          background: #f8fafc;
          padding: 16px;
          border-bottom: 1px solid #e2e8f0;
          border-radius: 8px 8px 0 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .mobile-day-nav {
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
          cursor: pointer;
        }
        
        .mobile-day-info {
          text-align: center;
        }
        
        .mobile-day-name {
          font-size: 18px;
          font-weight: 600;
          color: #1f2937;
        }
        
        .mobile-day-date {
          font-size: 14px;
          color: #6b7280;
        }
        
        .mobile-time-slots {
          padding: 8px;
        }
        
        .mobile-time-slot {
          display: flex;
          align-items: center;
          padding: 12px 16px;
          margin-bottom: 8px;
          background: #f9fafb;
          border: 1px solid #e5e7eb;
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s;
        }
        
        .mobile-time-slot:hover {
          background: #f3f4f6;
          border-color: #3b82f6;
        }
        
        .mobile-time {
          font-weight: 600;
          color: #374151;
          min-width: 60px;
          margin-right: 12px;
        }
        
        .mobile-slot-content {
          flex: 1;
          color: #6b7280;
        }
        
        /* Form optimizations */
        .modal-content {
          margin: 16px;
          max-height: calc(100vh - 32px);
          overflow-y: auto;
        }
        
        /* Button optimizations */
        button {
          min-height: 44px;
        }
        
        /* Input optimizations */
        input, select, textarea {
          min-height: 44px;
          font-size: 16px; /* Prevents zoom on iOS */
        }
        
        /* Navigation optimizations */
        .flex.items-center.space-x-2 {
          flex-wrap: wrap;
          gap: 8px;
        }
        
        /* Hide desktop-only elements */
        .hidden.sm\:block {
          display: none !important;
        }
      }
      
      /* Touch-friendly improvements */
      @media (hover: none) and (pointer: coarse) {
        button, .calendar-slot, .mobile-time-slot {
          min-height: 44px;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 flex h-screen w-full">
    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
    
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col fixed lg:relative h-full z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
      <div class="p-6 border-b border-gray-200">
        <h1 class="text-xl font-bold text-gray-900">Pass Plus SOM</h1>
        <p class="text-sm text-gray-500">Driving Instructor Dashboard</p>
      </div>
      
      <nav class="flex-1 p-4">
        <ul class="space-y-2">
          <li>
            <button onclick="showPage('home', event)" class="w-full flex items-center px-6 py-3 font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <i data-lucide="home" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">Home</span>
            </button>
          </li>
          <li>
            <button onclick="showPage('calendar', event)" class="w-full flex items-center px-6 py-3 font-medium text-white bg-green-600 rounded-lg active transition-colors duration-200">
              <i data-lucide="calendar" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">Calendar</span>
            </button>
          </li>
          <li>
            <button onclick="showPage('learners', event)" class="w-full flex items-center px-6 py-3 font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <i data-lucide="users" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">Learners</span>
            </button>
          </li>
          <li>
            <button onclick="showPage('finances', event)" class="w-full flex items-center px-6 py-3 font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <i data-lucide="pound-sterling" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">Finances</span>
            </button>
          </li>
          <li>
            <button onclick="showPage('documents', event)" class="w-full flex items-center px-6 py-3 font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <i data-lucide="file-text" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">Documents</span>
            </button>
          </li>
          <li>
            <button onclick="showPage('my-details', event)" class="w-full flex items-center px-6 py-3 font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <i data-lucide="user" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">My Details</span>
            </button>
          </li>
          <li id="admin-menu-item" class="hidden">
            <button onclick="showPage('document-review', event)" class="w-full flex items-center px-6 py-3 font-medium text-gray-700 rounded-lg hover:bg-gray-100 transition-colors duration-200">
              <i data-lucide="shield-check" class="w-5 h-5 mr-3 flex-shrink-0"></i>
              <span class="flex-1 text-left">Admin Review</span>
            </button>
          </li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden lg:ml-0">
      <!-- Header -->
      <header class="bg-white border-b border-gray-200 px-4 lg:px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-btn" class="lg:hidden p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
            <h2 id="page-title" class="text-xl lg:text-2xl font-semibold text-gray-900">Calendar</h2>
          </div>
          <div class="flex items-center space-x-2 lg:space-x-4">
            <span id="user-name" class="text-sm text-gray-500 hidden sm:block">Loading...</span>
            <button onclick="signOut()" class="text-sm text-gray-500 hover:text-gray-700 ml-2">
              Logout
            </button>
            <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
              <span id="user-initials" class="text-white text-sm font-medium">?</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <div class="flex-1 overflow-auto p-6">
        <!-- Home Page -->
        <div id="home-page" class="page-content hidden">
          <!-- Welcome Header -->
          <div class="mb-8">
            <h1 id="welcome-message" class="text-2xl font-bold text-gray-900">Welcome back</h1>
            <p class="text-gray-600">Here's what's happening with your driving school today</p>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button onclick="showPage('calendar', event)" class="inline-flex items-center justify-center px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors">
              <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
              New Lesson
            </button>
            <button onclick="exportData()" class="inline-flex items-center justify-center px-6 py-3 border border-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">
              <i data-lucide="download" class="w-5 h-5 mr-2"></i>
              Export Data
            </button>
          </div>
          
          <!-- Statistics Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 flex items-center justify-center bg-green-100 rounded-xl">
                  <i data-lucide="calendar-check" class="text-green-600 w-6 h-6"></i>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                  <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                </button>
              </div>
              <h3 class="text-gray-500 text-sm mb-2">Today's Lessons</h3>
              <div class="text-2xl font-bold text-gray-900">5</div>
              <div class="mt-2 text-sm text-gray-600">
                <span class="text-green-500">↑ 12%</span> vs last week
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 flex items-center justify-center bg-blue-100 rounded-xl">
                  <i data-lucide="pound-sterling" class="text-blue-600 w-6 h-6"></i>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                  <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                </button>
              </div>
              <h3 class="text-gray-500 text-sm mb-2">Weekly Revenue</h3>
              <div class="text-2xl font-bold text-gray-900">£750</div>
              <div class="mt-2 text-sm text-gray-600">
                <span class="text-green-500">↑ 8%</span> vs last week
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 flex items-center justify-center bg-purple-100 rounded-xl">
                  <i data-lucide="user-plus" class="text-purple-600 w-6 h-6"></i>
                </div>
                <button class="text-gray-400 hover:text-gray-600">
                  <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                </button>
              </div>
              <h3 class="text-gray-500 text-sm mb-2">New Pupils</h3>
              <div class="text-2xl font-bold text-gray-900">3</div>
              <div class="mt-2 text-sm text-gray-600">
                <span class="text-green-500">↑ 2</span> this week
              </div>
            </div>
          </div>
          
          <!-- Dashboard Widgets -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Today's Schedule -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
              <div class="p-6 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900">Today's Schedule</h2>
              </div>
              <div class="p-6">
                <div class="space-y-6">
                  <div class="flex items-center">
                    <div class="w-12 text-center">
                      <div class="text-sm font-medium text-gray-900">09:00</div>
                      <div class="text-xs text-gray-500">AM</div>
                    </div>
                    <div class="ml-4 flex-1">
                      <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                          <div>
                            <div class="text-sm font-medium text-gray-900">Sarah Johnson</div>
                            <div class="text-xs text-gray-500">2 hour lesson - Manual</div>
                          </div>
                          <div class="flex items-center space-x-2">
                            <button class="text-gray-400 hover:text-gray-600">
                              <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-gray-400 hover:text-gray-600">
                              <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="flex items-center">
                    <div class="w-12 text-center">
                      <div class="text-sm font-medium text-gray-900">11:30</div>
                      <div class="text-xs text-gray-500">AM</div>
                    </div>
                    <div class="ml-4 flex-1">
                      <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                          <div>
                            <div class="text-sm font-medium text-gray-900">Mike Peters</div>
                            <div class="text-xs text-gray-500">1 hour lesson - Automatic</div>
                          </div>
                          <div class="flex items-center space-x-2">
                            <button class="text-gray-400 hover:text-gray-600">
                              <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-gray-400 hover:text-gray-600">
                              <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="flex items-center">
                    <div class="w-12 text-center">
                      <div class="text-sm font-medium text-gray-900">14:00</div>
                      <div class="text-xs text-gray-500">PM</div>
                    </div>
                    <div class="ml-4 flex-1">
                      <div class="bg-green-50 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                          <div>
                            <div class="text-sm font-medium text-gray-900">Emma Wilson</div>
                            <div class="text-xs text-gray-500">Test preparation - Manual</div>
                          </div>
                          <div class="flex items-center space-x-2">
                            <button class="text-gray-400 hover:text-gray-600">
                              <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button class="text-gray-400 hover:text-gray-600">
                              <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recent Payments -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
              <div class="p-6 border-b border-gray-100">
                <h2 class="text-lg font-semibold text-gray-900">Recent Payments</h2>
              </div>
              <div class="p-6">
                <div class="space-y-4">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 flex items-center justify-center bg-blue-50 rounded-full">
                        <i data-lucide="credit-card" class="text-blue-600 w-5 h-5"></i>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">Emma Wilson</div>
                        <div class="text-xs text-gray-500">Card payment - 2 hours</div>
                      </div>
                    </div>
                    <div class="text-sm font-medium text-gray-900">£60</div>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 flex items-center justify-center bg-blue-50 rounded-full">
                        <i data-lucide="credit-card" class="text-blue-600 w-5 h-5"></i>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">James Brown</div>
                        <div class="text-xs text-gray-500">Card payment - 1 hour</div>
                      </div>
                    </div>
                    <div class="text-sm font-medium text-gray-900">£30</div>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 flex items-center justify-center bg-blue-50 rounded-full">
                        <i data-lucide="credit-card" class="text-blue-600 w-5 h-5"></i>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">Lucy Davis</div>
                        <div class="text-xs text-gray-500">Card payment - 2 hours</div>
                      </div>
                    </div>
                    <div class="text-sm font-medium text-gray-900">£60</div>
                  </div>
                  
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="w-10 h-10 flex items-center justify-center bg-green-50 rounded-full">
                        <i data-lucide="banknote" class="text-green-600 w-5 h-5"></i>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">Sarah Johnson</div>
                        <div class="text-xs text-gray-500">Cash payment - 1 hour</div>
                      </div>
                    </div>
                    <div class="text-sm font-medium text-gray-900">£30</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendar-page" class="page-content">
          <div class="bg-white rounded-lg shadow flex flex-col h-screen max-h-[calc(100vh-2rem)]">
            <!-- Calendar Header - Fixed -->
            <div class="p-6 border-b border-gray-200 flex-shrink-0">
              <div class="flex items-center justify-between">
                <h3 id="current-month-year" class="text-lg font-medium text-gray-900">Loading...</h3>
                <div class="flex items-center space-x-2">
                  <button id="prev-week-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                  </button>
                  <button id="today-btn" class="px-4 py-2 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Today
                  </button>
                  <button id="next-week-btn" class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg">
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Calendar Content Area -->
            <div class="flex-1 flex flex-col min-h-0">
              <!-- Days Header - Sticky -->
              <div id="calendar-days-header" class="grid grid-cols-8 border-b border-gray-200 bg-white sticky top-0 z-10 px-6 py-2 flex-shrink-0">
                <div class="w-14"></div>
                <div class="text-center font-medium text-gray-700 py-2">MON</div>
                <div class="text-center font-medium text-gray-700 py-2">TUE</div>
                <div class="text-center font-medium text-gray-700 py-2">WED</div>
                <div class="text-center font-medium text-gray-700 py-2">THU</div>
                <div class="text-center font-medium text-gray-700 py-2">FRI</div>
                <div class="text-center font-medium text-gray-700 py-2">SAT</div>
                <div class="text-center font-medium text-gray-700 py-2">SUN</div>
              </div>

              <!-- Calendar Body - Scrollable -->
              <div class="flex-1 overflow-y-auto px-6">
                <div id="calendar-body" class="border-l border-r border-b border-gray-200 rounded-b-lg">
                  <div class="text-center py-8 text-gray-500">Loading calendar...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Learners Page -->
        <div id="learners-page" class="page-content hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">My Learners</h3>
                <button onclick="showAddLearnerModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                  + Add New Learner
                </button>
              </div>
            </div>
            <div class="p-6">
              <div id="learners-list" class="space-y-4">
                <!-- Learner items will be dynamically added here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Finances Page -->
        <div id="finances-page" class="page-content hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
              <div class="flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Financial Overview</h3>
                <div class="flex space-x-3">
                  <button onclick="showAddTransactionModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Add Transaction
                  </button>
                  <button onclick="exportFinancialData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    Export Data
                  </button>
                </div>
              </div>
            </div>
            <div class="p-6">
              <!-- Financial Summary -->
              <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                  <h4 class="text-lg font-semibold text-green-800 mb-2">Total Income</h4>
                  <p class="text-3xl font-bold text-green-600" id="totalIncome">£0.00</p>
                </div>
                <div class="bg-red-50 p-6 rounded-lg border border-red-200">
                  <h4 class="text-lg font-semibold text-red-800 mb-2">Total Expenses</h4>
                  <p class="text-3xl font-bold text-red-600" id="totalExpenses">£0.00</p>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                  <h4 class="text-lg font-semibold text-blue-800 mb-2">Net Profit</h4>
                  <p class="text-3xl font-bold text-blue-600" id="netProfit">£0.00</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                  <h4 class="text-lg font-semibold text-gray-800 mb-2">This Month</h4>
                  <p class="text-3xl font-bold text-gray-600" id="thisMonthNet">£0.00</p>
                </div>
              </div>
              
              <!-- Financial Controls -->
              <div class="flex flex-wrap gap-4 mb-6">
                <div>
                  <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                  <select id="dateFilter" onchange="applyFilters()" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="all">All Time</option>
                    <option value="this-month">This Month</option>
                    <option value="last-month">Last Month</option>
                    <option value="this-year">This Year</option>
                  </select>
                </div>
                <div>
                  <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                  <select id="categoryFilter" onchange="applyFilters()" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="all">All Categories</option>
                    <option value="income">Income Only</option>
                    <option value="expense">Expenses Only</option>
                  </select>
                </div>
                <div>
                  <label for="monthlySelector" class="block text-sm font-medium text-gray-700 mb-1">Monthly View</label>
                  <select id="monthlySelector" onchange="handleMonthlySelection(event)" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="">Select Month...</option>
                  </select>
                </div>
              </div>
              
              <!-- Financial Table -->
              <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                      <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Transaction data will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- My Details Page -->
        <div id="my-details-page" class="page-content hidden">
          <div class="bg-white rounded-lg shadow">
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
              <nav class="flex space-x-8 px-6 pt-6" aria-label="Tabs">
                <button onclick="showDetailsTab('personal')" class="details-tab border-b-2 border-green-500 text-green-600 py-2 px-1 text-sm font-medium" aria-current="page">
                  Personal Details
                </button>
                <button onclick="showDetailsTab('vehicles')" class="details-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                  My Vehicles
                </button>
                <button onclick="showDetailsTab('qualifications')" class="details-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                  My Qualifications
                </button>
                <button onclick="showDetailsTab('areas')" class="details-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                  Areas Covered
                </button>
                <button onclick="showDetailsTab('preferences')" class="details-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                  Preferences
                </button>
              </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
              <!-- Personal Details Tab -->
              <div id="personal-tab" class="details-tab-content">
                <form id="personal-details-form" class="space-y-6">
                  <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">My name & address</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="first-name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                        <input type="text" id="first-name" name="first_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="last-name" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                        <input type="text" id="last-name" name="last_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="address-line1" class="block text-sm font-medium text-gray-700 mb-1">Address Line 1</label>
                        <input type="text" id="address-line1" name="address_line1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="address-line2" class="block text-sm font-medium text-gray-700 mb-1">Address Line 2</label>
                        <input type="text" id="address-line2" name="address_line2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                      <div>
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <input type="text" id="city" name="city" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="postcode" class="block text-sm font-medium text-gray-700 mb-1">Postcode</label>
                        <input type="text" id="postcode" name="postcode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="date-of-birth" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                        <input type="date" id="date-of-birth" name="date_of_birth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Email and telephone</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telephone Number</label>
                        <input type="tel" id="phone" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" required>
                      </div>
                      <div>
                        <label for="emergency-contact-name" class="block text-sm font-medium text-gray-700 mb-1">Emergency Contact Name</label>
                        <input type="text" id="emergency-contact-name" name="emergency_contact_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                      <div>
                        <label for="emergency-contact-phone" class="block text-sm font-medium text-gray-700 mb-1">Emergency Contact Phone</label>
                        <input type="tel" id="emergency-contact-phone" name="emergency_contact_phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                    </div>
                  </div>
                  
                  <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Save Personal Details
                  </button>
                </form>
              </div>

              <!-- Vehicles Tab -->
              <div id="vehicles-tab" class="details-tab-content hidden">
                <div class="space-y-6">
                  <h4 class="text-lg font-medium text-gray-900">My vehicles</h4>
                  <div id="vehicles-list" class="space-y-4">
                    <!-- Vehicle items will be dynamically added here -->
                  </div>
                  <button type="button" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="addVehicle()">
                    + Add Vehicle
                  </button>
                  <button type="button" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" onclick="saveVehicles()">
                    Save Vehicles
                  </button>
                </div>
              </div>

              <!-- Qualifications Tab -->
              <div id="qualifications-tab" class="details-tab-content hidden">
                <div class="space-y-6">
                  <h4 class="text-lg font-medium text-gray-900">My qualifications</h4>
                  <div id="qualifications-list" class="space-y-4">
                    <!-- Qualification items will be dynamically added here -->
                  </div>
                  <button type="button" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="addQualification()">
                    + Add Qualification
                  </button>
                  <button type="button" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" onclick="saveQualifications()">
                    Save Qualifications
                  </button>
                </div>
              </div>

              <!-- Areas Tab -->
              <div id="areas-tab" class="details-tab-content hidden">
                <div class="space-y-6">
                  <h4 class="text-lg font-medium text-gray-900">Areas I cover</h4>
                  <p class="text-gray-600">Add the postcodes and areas where you provide driving lessons.</p>
                  <div id="areas-list" class="space-y-4">
                    <!-- Area items will be dynamically added here -->
                  </div>
                  <button type="button" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" onclick="addArea()">
                    + Add Area/Postcode
                  </button>
                  <button type="button" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2" onclick="saveAreas()">
                    Save Areas
                  </button>
                </div>
              </div>

              <!-- Preferences Tab -->
              <div id="preferences-tab" class="details-tab-content hidden">
                <form id="preferences-form" class="space-y-6">
                  <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Lesson preferences</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="lesson-duration" class="block text-sm font-medium text-gray-700 mb-1">Preferred Lesson Duration</label>
                        <select id="lesson-duration" name="lesson_duration" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                          <option value="60">1 Hour</option>
                          <option value="90">1.5 Hours</option>
                          <option value="120">2 Hours</option>
                        </select>
                      </div>
                      <div>
                        <label for="max-pupils" class="block text-sm font-medium text-gray-700 mb-1">Maximum Number of Pupils</label>
                        <input type="number" id="max-pupils" name="max_pupils" min="1" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                      <div>
                        <label for="lesson-price" class="block text-sm font-medium text-gray-700 mb-1">Standard Lesson Price (£)</label>
                        <input type="number" id="lesson-price" name="lesson_price" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                      <div>
                        <label for="intensive-price" class="block text-sm font-medium text-gray-700 mb-1">Intensive Course Price (£)</label>
                        <input type="number" id="intensive-price" name="intensive_price" min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Working hours</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">Earliest Start Time</label>
                        <input type="time" id="start-time" name="start_time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                      <div>
                        <label for="end-time" class="block text-sm font-medium text-gray-700 mb-1">Latest End Time</label>
                        <input type="time" id="end-time" name="end_time" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                      </div>
                      <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Working Days</label>
                        <div class="flex flex-wrap gap-4">
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="monday" class="mr-2 text-green-600 focus:ring-green-500"> Monday</label>
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="tuesday" class="mr-2 text-green-600 focus:ring-green-500"> Tuesday</label>
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="wednesday" class="mr-2 text-green-600 focus:ring-green-500"> Wednesday</label>
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="thursday" class="mr-2 text-green-600 focus:ring-green-500"> Thursday</label>
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="friday" class="mr-2 text-green-600 focus:ring-green-500"> Friday</label>
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="saturday" class="mr-2 text-green-600 focus:ring-green-500"> Saturday</label>
                          <label class="flex items-center"><input type="checkbox" name="working_days" value="sunday" class="mr-2 text-green-600 focus:ring-green-500"> Sunday</label>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Additional preferences</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="automatic-only" class="block text-sm font-medium text-gray-700 mb-1">Transmission Type</label>
                        <select id="automatic-only" name="automatic_only" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                          <option value="false">Manual & Automatic</option>
                          <option value="true">Automatic Only</option>
                        </select>
                      </div>
                      <div>
                        <label for="female-only" class="block text-sm font-medium text-gray-700 mb-1">Student Preference</label>
                        <select id="female-only" name="female_only" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                          <option value="false">All Students</option>
                          <option value="true">Female Students Only</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <label for="special-requirements" class="block text-sm font-medium text-gray-700 mb-1">Special Requirements</label>
                    <textarea id="special-requirements" name="special_requirements" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Any special requirements, teaching methods, or additional information..."></textarea>
                  </div>
                  
                  <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Save Preferences
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents Page -->
        <div id="documents-page" class="page-content hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">My Documents</h3>
                <button onclick="showUploadDocumentModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                  📸 Upload Document
                </button>
              </div>
            </div>
            <div class="p-6">
              <div id="documents-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Document items will be dynamically added here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Document Review Page (Admin Only) -->
        <div id="document-review-page" class="page-content hidden">
          <div class="bg-white rounded-lg shadow">
            <div class="p-6 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">Document Review Queue</h3>
                <div class="flex items-center space-x-4">
                  <span id="pending-count" class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-sm font-medium">0 pending</span>
                  <button onclick="loadPendingDocuments()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    🔄 Refresh
                  </button>
                </div>
              </div>
            </div>
            <div class="p-6">
              <div id="pending-documents-list" class="space-y-6">
                <!-- Pending documents will be dynamically added here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Upload Document Modal -->
    <div id="uploadDocumentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">Upload Document</h3>
            <button onclick="hideUploadDocumentModal()" class="text-gray-400 hover:text-gray-600">
              <span class="sr-only">Close</span>
              <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        <form id="upload-document-form" onsubmit="uploadDocument(event)" class="p-6">
          <div class="space-y-4">
            <div>
              <label for="document-type" class="block text-sm font-medium text-gray-700 mb-1">Document Type *</label>
              <select id="document-type" name="document_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">Select Document Type</option>
                <option value="ADI_License">ADI Certificate</option>
                <option value="DBS_Check">DBS Certificate</option>
                <option value="Insurance_Certificate">Car Insurance</option>
                <option value="MOT_Certificate">MOT Certificate</option>
                <option value="Medical_Certificate">Medical Certificate</option>
                <option value="Training_Certificate">Training Certificate</option>
                <option value="Business_License">Business License</option>
                <option value="Receipt">Receipt/Expense</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label for="document-file" class="block text-sm font-medium text-gray-700 mb-1">Document Photo/File *</label>
              <input type="file" id="document-file" name="document_file" accept="image/*,application/pdf" capture="camera" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              <p class="text-xs text-gray-500 mt-1">Take a photo or select an image/PDF file (max 10MB)</p>
            </div>
            <div>
              <label for="document-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
              <textarea id="document-notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Any additional information about this document..."></textarea>
            </div>
            <div>
              <label for="document-expiry" class="block text-sm font-medium text-gray-700 mb-1">Expiry Date (Optional)</label>
              <input type="date" id="document-expiry" name="expiry_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
          </div>
          <div class="flex justify-end space-x-3 pt-6">
            <button type="button" onclick="hideUploadDocumentModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
              Cancel
            </button>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
              📸 Upload Document
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Document Viewer Modal -->
    <div id="documentViewerModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
          <h3 id="viewer-document-title" class="text-lg font-medium text-gray-900">Document</h3>
          <button onclick="hideDocumentViewer()" class="text-gray-400 hover:text-gray-600">
            <span class="sr-only">Close</span>
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-4 max-h-[80vh] overflow-auto">
          <div id="document-viewer-content" class="flex justify-center">
            <!-- Document content will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Transaction</h3>
          <form id="addTransactionForm" onsubmit="handleAddTransaction(event)">
            <div class="mb-4">
              <label for="transactionType" class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
              <select id="transactionType" name="type" onchange="updateCategoryOptions()" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="transactionCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
              <select id="transactionCategory" name="category" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                <!-- Options will be populated by updateCategoryOptions() -->
              </select>
            </div>
            <div class="mb-4">
              <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount (£)</label>
              <input type="number" id="transactionAmount" name="amount" step="0.01" min="0" required class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-4">
              <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
              <input type="text" id="transactionDescription" name="description" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-4">
              <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input type="date" id="transactionDate" name="date" required class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-6">
              <label for="taxCategory" class="block text-sm font-medium text-gray-700 mb-1">Tax Category</label>
              <select id="taxCategory" name="tax_category" class="w-full border border-gray-300 rounded-md px-3 py-2">
                <option value="business">Business</option>
                <option value="personal">Personal</option>
                <option value="mixed">Mixed</option>
              </select>
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="hideAddTransactionModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Add Transaction
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Monthly Breakdown Modal -->
    <div id="monthlyBreakdownModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-10 mx-auto p-5 border w-4/5 max-w-4xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <div class="flex justify-between items-center mb-6">
            <h3 id="modalMonthTitle" class="text-xl font-medium text-gray-900">Monthly Breakdown</h3>
            <button onclick="hideMonthlyBreakdown()" class="text-gray-400 hover:text-gray-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-green-50 p-6 rounded-lg border border-green-200 text-center">
              <h4 class="text-lg font-semibold text-green-800 mb-2">Total Income</h4>
              <p id="modalIncomeTotal" class="text-2xl font-bold text-green-600">£0.00</p>
            </div>
            <div class="bg-red-50 p-6 rounded-lg border border-red-200 text-center">
              <h4 class="text-lg font-semibold text-red-800 mb-2">Total Expenses</h4>
              <p id="modalExpenseTotal" class="text-2xl font-bold text-red-600">£0.00</p>
            </div>
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 text-center">
              <h4 class="text-lg font-semibold text-blue-800 mb-2">Net Profit</h4>
              <p id="modalNetProfit" class="text-2xl font-bold text-blue-600">£0.00</p>
            </div>
          </div>
          
          <!-- Category Breakdown Table -->
          <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <table class="min-w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Transactions</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                </tr>
              </thead>
              <tbody id="modalBreakdownTable" class="bg-white">
                <!-- Category breakdown will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Vehicle Modal -->
    <div id="addVehicleModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Vehicle</h3>
          <form id="addVehicleForm" onsubmit="handleAddVehicle(event)">
            <div class="mb-4">
              <label for="vehicleMake" class="block text-sm font-medium text-gray-700 mb-1">Make</label>
              <input type="text" id="vehicleMake" name="make" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., Ford">
            </div>
            <div class="mb-4">
              <label for="vehicleModel" class="block text-sm font-medium text-gray-700 mb-1">Model</label>
              <input type="text" id="vehicleModel" name="model" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., Focus">
            </div>
            <div class="mb-4">
              <label for="vehicleYear" class="block text-sm font-medium text-gray-700 mb-1">Year</label>
              <input type="number" id="vehicleYear" name="year" min="1900" max="2030" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., 2020">
            </div>
            <div class="mb-4">
              <label for="vehicleRegistration" class="block text-sm font-medium text-gray-700 mb-1">Registration</label>
              <input type="text" id="vehicleRegistration" name="registration" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., AB12 CDE">
            </div>
            <div class="mb-4">
              <label for="vehicleFuelType" class="block text-sm font-medium text-gray-700 mb-1">Fuel Type</label>
              <select id="vehicleFuelType" name="fuel_type" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                <option value="">Select fuel type</option>
                <option value="Petrol">Petrol</option>
                <option value="Diesel">Diesel</option>
                <option value="Hybrid">Hybrid</option>
                <option value="Electric">Electric</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="vehicleTransmission" class="block text-sm font-medium text-gray-700 mb-1">Transmission</label>
              <select id="vehicleTransmission" name="transmission" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                <option value="">Select transmission</option>
                <option value="Manual">Manual</option>
                <option value="Automatic">Automatic</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="vehicleInsuranceExpiry" class="block text-sm font-medium text-gray-700 mb-1">Insurance Expiry</label>
              <input type="date" id="vehicleInsuranceExpiry" name="insurance_expiry" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-4">
              <label for="vehicleMOTExpiry" class="block text-sm font-medium text-gray-700 mb-1">MOT Expiry</label>
              <input type="date" id="vehicleMOTExpiry" name="mot_expiry" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-6">
              <label for="vehicleRoadTaxExpiry" class="block text-sm font-medium text-gray-700 mb-1">Road Tax Expiry</label>
              <input type="date" id="vehicleRoadTaxExpiry" name="road_tax_expiry" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="hideAddVehicleModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Add Vehicle
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Add Qualification Modal -->
    <div id="addQualificationModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Qualification</h3>
          <form id="addQualificationForm" onsubmit="handleAddQualification(event)">
            <div class="mb-4">
              <label for="qualificationType" class="block text-sm font-medium text-gray-700 mb-1">Qualification Type</label>
              <select id="qualificationType" name="qualification_type" required class="w-full border border-gray-300 rounded-md px-3 py-2">
                <option value="">Select type</option>
                <option value="ADI">ADI (Approved Driving Instructor)</option>
                <option value="PDI">PDI (Potential Driving Instructor)</option>
                <option value="Fleet Training">Fleet Training</option>
                <option value="Theory Test Training">Theory Test Training</option>
                <option value="Hazard Perception">Hazard Perception</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="qualificationName" class="block text-sm font-medium text-gray-700 mb-1">Qualification Name</label>
              <input type="text" id="qualificationName" name="qualification_name" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., ADI Certificate">
            </div>
            <div class="mb-4">
              <label for="issuingBody" class="block text-sm font-medium text-gray-700 mb-1">Issuing Body</label>
              <input type="text" id="issuingBody" name="issuing_body" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., DVSA">
            </div>
            <div class="mb-4">
              <label for="issueDate" class="block text-sm font-medium text-gray-700 mb-1">Issue Date</label>
              <input type="date" id="issueDate" name="issue_date" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-4">
              <label for="expiryDate" class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
              <input type="date" id="expiryDate" name="expiry_date" class="w-full border border-gray-300 rounded-md px-3 py-2">
            </div>
            <div class="mb-6">
              <label for="referenceNumber" class="block text-sm font-medium text-gray-700 mb-1">Reference Number</label>
              <input type="text" id="referenceNumber" name="reference_number" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., ADI123456">
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="hideAddQualificationModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Add Qualification
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Add Area Modal -->
    <div id="addAreaModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Area</h3>
          <form id="addAreaForm" onsubmit="handleAddArea(event)">
            <div class="mb-4">
              <label for="areaName" class="block text-sm font-medium text-gray-700 mb-1">Area Name</label>
              <input type="text" id="areaName" name="area_name" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., City Centre, North London">
            </div>
            <div class="mb-4">
              <label for="areaPostcode" class="block text-sm font-medium text-gray-700 mb-1">Postcode</label>
              <input type="text" id="areaPostcode" name="postcode" required class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="e.g., SW1A 1AA">
              <div id="areaPostcodeFeedback" class="text-sm mt-1"></div>
            </div>
            <div class="mb-6">
              <label for="additionalCharge" class="block text-sm font-medium text-gray-700 mb-1">Additional Charge (£)</label>
              <input type="number" id="additionalCharge" name="additional_charge" step="0.01" min="0" value="0" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="0.00">
              <p class="text-sm text-gray-500 mt-1">Extra cost for lessons in this area (optional)</p>
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="hideAddAreaModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Add Area
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Lesson Details Modal -->
    <div id="lesson-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-medium text-gray-900">Lesson Details</h3>
            <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="space-y-3">
            <div>
              <label class="text-sm font-medium text-gray-700">Pupil:</label>
              <p id="modal-pupil-name" class="text-gray-900">-</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700">Instructor:</label>
              <p id="modal-instructor-name" class="text-gray-900">-</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700">Date & Time:</label>
              <p id="modal-lesson-datetime" class="text-gray-900">-</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700">Duration:</label>
              <p id="modal-lesson-duration" class="text-gray-900">-</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700">Pickup Address:</label>
              <p id="modal-pickup-address" class="text-gray-900">-</p>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700">Notes:</label>
              <p id="modal-lesson-notes" class="text-gray-900">-</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add New Learner Modal -->
    <div id="addLearnerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900">Add New Learner</h2>
            <button onclick="hideAddLearnerModal()" class="text-gray-400 hover:text-gray-600">
              <i data-lucide="x" class="w-6 h-6"></i>
            </button>
          </div>
        </div>
        <div class="p-6">
          <form id="addLearnerForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="learner-first-name" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                <input type="text" id="learner-first-name" name="first_name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="learner-last-name" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                <input type="text" id="learner-last-name" name="last_name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="learner-email" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                <input type="email" id="learner-email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="learner-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                <input type="tel" id="learner-phone" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="learner-dob" class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                <input type="date" id="learner-dob" name="date_of_birth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="learner-license-number" class="block text-sm font-medium text-gray-700 mb-1">Provisional License Number</label>
                <input type="text" id="learner-license-number" name="provisional_license_number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
            </div>
            <div>
              <label for="learner-address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
              <textarea id="learner-address" name="address" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="House number, street name, etc."></textarea>
            </div>
            <div>
              <label for="learner-postcode" class="block text-sm font-medium text-gray-700 mb-1">Postcode</label>
              <input type="text" id="learner-postcode" name="postcode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="e.g., SW1A 1AA">
              <div id="learnerPostcodeFeedback" class="text-sm mt-1"></div>
            </div>
            <div>
              <label for="learner-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
              <textarea id="learner-notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Any special requirements, medical conditions, etc."></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="hideAddLearnerModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                Add Learner
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Add Lesson Modal -->
    <div id="addLessonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900">Add New Lesson</h2>
            <button onclick="hideAddLessonModal()" class="text-gray-400 hover:text-gray-600">
              <i data-lucide="x" class="w-6 h-6"></i>
            </button>
          </div>
        </div>
        <div class="p-6">
          <form id="addLessonForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="lesson-type" class="block text-sm font-medium text-gray-700 mb-1">Lesson Type *</label>
                <select id="lesson-type" name="lesson_type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="lesson">Lesson</option>
                  <option value="unavailable">Unavailable</option>
                </select>
              </div>
              <div id="learner-field">
                <label for="lesson-learner" class="block text-sm font-medium text-gray-700 mb-1">Learner *</label>
                <select id="lesson-learner" name="pupil_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="">Select a learner...</option>
                </select>
              </div>
              <div>
                <label for="lesson-date" class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                <input type="date" id="lesson-date" name="lesson_date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="lesson-start-time" class="block text-sm font-medium text-gray-700 mb-1">Start Time *</label>
                <input type="time" id="lesson-start-time" name="start_time" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
              </div>
              <div>
                <label for="lesson-duration" class="block text-sm font-medium text-gray-700 mb-1">Duration (minutes) *</label>
                <select id="lesson-duration" name="duration_minutes" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <option value="60">1 Hour</option>
                  <option value="90">1.5 Hours</option>
                  <option value="120">2 Hours</option>
                </select>
              </div>
            </div>
            <div>
              <label for="lesson-pickup-address" class="block text-sm font-medium text-gray-700 mb-1">Pickup Address</label>
              <input type="text" id="lesson-pickup-address" name="pickup_address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
              <label for="lesson-notes" class="block text-sm font-medium text-gray-700 mb-1">Lesson Notes</label>
              <textarea id="lesson-notes" name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Lesson objectives, areas to focus on, etc."></textarea>
            </div>
            <div class="flex justify-end space-x-3 pt-4">
              <button type="button" onclick="hideAddLessonModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                Add Lesson
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Initialize Supabase with anon key for authenticated access
      const supabaseUrl = 'https://yqphthblvsteecczprcs.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxcGh0aGJsdnN0ZWVjY3pwcmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMjE3MDQsImV4cCI6MjA2ODY5NzcwNH0.moAWw96xbIZEFnBIIWAi36OfuahyqO0WBzJdilXeBfg';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // Authentication functions
      async function checkAuthentication() {
          // First check for OAuth session (handles Google OAuth callback)
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          if (session?.user) {
              console.log('✅ OAuth session found:', session.user.email);
              return session.user;
          }

          // Then check for regular user session
          const { data: { user }, error } = await supabase.auth.getUser();
          if (!user) {
              // Redirect to login page if not authenticated
              window.location.href = '../login.html';
              return null;
          }
          return user;
      }

      async function signOut() {
          const { error } = await supabase.auth.signOut();
          if (error) {
              console.error('Error signing out:', error);
          } else {
              window.location.href = '../login.html';
          }
      }

      // Update user interface with authenticated user info
      function updateUserInterface() {
          if (currentUser) {
              const fullName = currentUser.full_name || currentUser.email;
              const firstName = currentUser.first_name || fullName.split(' ')[0];

              // Update header
              document.getElementById('user-name').textContent = fullName;
              document.getElementById('welcome-message').textContent = `Welcome back, ${firstName}`;

              // Update initials
              const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
              document.getElementById('user-initials').textContent = initials;

              // Show admin menu if user is admin
              if (currentUser.admin_role === 'admin' || currentUser.admin_role === 'super_admin') {
                  document.getElementById('admin-menu-item').classList.remove('hidden');
              }
          }
      }

      // Document Management Functions
      async function loadMyDocuments() {
          try {
              if (!currentUser?.id) {
                  renderDocuments([]);
                  return;
              }

              const { data: documents, error } = await supabase
                  .from('documents')
                  .select('*')
                  .eq('instructor_id', currentUser.id)
                  .order('upload_date', { ascending: false });

              if (error) {
                  console.error('Error loading documents:', error);
                  renderDocuments([]);
                  return;
              }

              renderDocuments(documents);
          } catch (error) {
              console.error('Error loading documents:', error);
              renderDocuments([]);
          }
      }

      function renderDocuments(documents) {
          const documentsList = document.getElementById('documents-list');
          documentsList.innerHTML = '';

          if (documents.length === 0) {
              documentsList.innerHTML = `
                  <div class="col-span-full text-center py-12">
                      <div class="text-gray-400 mb-4">
                          <svg class="w-16 h-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                      </div>
                      <h3 class="text-lg font-medium text-gray-900 mb-2">No documents uploaded</h3>
                      <p class="text-gray-500 mb-4">Upload your first document to get started</p>
                      <button onclick="showUploadDocumentModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                          📸 Upload Document
                      </button>
                  </div>
              `;
              return;
          }

          documents.forEach(doc => {
              const docDiv = document.createElement('div');
              docDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';

              const statusColor = {
                  'pending': 'bg-yellow-100 text-yellow-800',
                  'approved': 'bg-green-100 text-green-800',
                  'rejected': 'bg-red-100 text-red-800'
              }[doc.status] || 'bg-gray-100 text-gray-800';

              const statusIcon = {
                  'pending': '⏳',
                  'approved': '✅',
                  'rejected': '❌'
              }[doc.status] || '📄';

              docDiv.innerHTML = `
                  <div class="flex items-start justify-between mb-3">
                      <div class="flex items-center">
                          <span class="text-2xl mr-3">${statusIcon}</span>
                          <div>
                              <h4 class="font-medium text-gray-900">${formatDocumentType(doc.document_type)}</h4>
                              <p class="text-sm text-gray-500">Uploaded ${new Date(doc.upload_date).toLocaleDateString()}</p>
                          </div>
                      </div>
                      <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
                          ${doc.status.charAt(0).toUpperCase() + doc.status.slice(1)}
                      </span>
                  </div>

                  ${doc.expiry_date ? `
                      <div class="mb-3">
                          <p class="text-sm text-gray-600">
                              <span class="font-medium">Expires:</span> ${new Date(doc.expiry_date).toLocaleDateString()}
                          </p>
                      </div>
                  ` : ''}

                  ${doc.review_notes ? `
                      <div class="mb-3 p-2 bg-gray-50 rounded">
                          <p class="text-sm text-gray-700">
                              <span class="font-medium">Review Notes:</span> ${doc.review_notes}
                          </p>
                      </div>
                  ` : ''}

                  <div class="flex justify-between items-center">
                      <button onclick="viewDocument('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                          👁️ View Document
                      </button>
                      <button onclick="deleteDocument('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                          🗑️ Delete
                      </button>
                  </div>
              `;

              documentsList.appendChild(docDiv);
          });
      }

      function formatDocumentType(type) {
          const types = {
              'ADI_License': 'ADI Certificate',
              'DBS_Check': 'DBS Certificate',
              'Insurance_Certificate': 'Car Insurance',
              'MOT_Certificate': 'MOT Certificate',
              'Medical_Certificate': 'Medical Certificate',
              'Training_Certificate': 'Training Certificate',
              'Business_License': 'Business License',
              'Receipt': 'Receipt/Expense',
              'Other': 'Other Document'
          };
          return types[type] || type;
      }

      // Modal functions
      function showUploadDocumentModal() {
          document.getElementById('uploadDocumentModal').classList.remove('hidden');
          document.getElementById('uploadDocumentModal').classList.add('flex');
      }

      function hideUploadDocumentModal() {
          document.getElementById('uploadDocumentModal').classList.add('hidden');
          document.getElementById('uploadDocumentModal').classList.remove('flex');
          document.getElementById('upload-document-form').reset();
      }

      // Upload document function
      async function uploadDocument(event) {
          event.preventDefault();

          if (!currentUser?.id) {
              alert('No user session found');
              return;
          }

          const formData = new FormData(event.target);
          const file = formData.get('document_file');
          const documentType = formData.get('document_type');
          const notes = formData.get('notes');
          const expiryDate = formData.get('expiry_date');

          if (!file || !documentType) {
              alert('Please select a file and document type');
              return;
          }

          // Check file size (10MB limit)
          if (file.size > 10 * 1024 * 1024) {
              alert('File size must be less than 10MB');
              return;
          }

          try {
              // Generate unique filename
              const fileExt = file.name.split('.').pop();
              const fileName = `${currentUser.id}/${documentType}-${Date.now()}.${fileExt}`;

              // Upload to Supabase Storage
              const { data: uploadData, error: uploadError } = await supabase.storage
                  .from('instructor-documents')
                  .upload(fileName, file);

              if (uploadError) throw uploadError;

              // Save document record
              const { data: docData, error: docError } = await supabase
                  .from('documents')
                  .insert([{
                      instructor_id: currentUser.id,
                      document_type: documentType,
                      file_path: fileName,
                      original_filename: file.name,
                      notes: notes || null,
                      expiry_date: expiryDate || null,
                      status: 'pending'
                  }]);

              if (docError) throw docError;

              alert('Document uploaded successfully! It will be reviewed shortly.');
              hideUploadDocumentModal();
              loadMyDocuments(); // Refresh the document list

          } catch (error) {
              console.error('Upload error:', error);
              alert('Upload failed: ' + error.message);
          }
      }

      // Admin Review Functions
      async function loadPendingDocuments() {
          try {
              // Check if user is admin
              if (!currentUser?.admin_role || (currentUser.admin_role !== 'admin' && currentUser.admin_role !== 'super_admin')) {
                  document.getElementById('pending-documents-list').innerHTML = '<p class="text-red-600">Access denied. Admin privileges required.</p>';
                  return;
              }

              const { data: documents, error } = await supabase
                  .from('documents')
                  .select(`
                      *,
                      instructor:instructors(full_name, email)
                  `)
                  .eq('status', 'pending')
                  .order('upload_date', { ascending: false });

              if (error) {
                  console.error('Error loading pending documents:', error);
                  return;
              }

              renderPendingDocuments(documents);
              updatePendingCount(documents.length);

          } catch (error) {
              console.error('Error loading pending documents:', error);
          }
      }

      function renderPendingDocuments(documents) {
          const pendingList = document.getElementById('pending-documents-list');
          pendingList.innerHTML = '';

          if (documents.length === 0) {
              pendingList.innerHTML = `
                  <div class="text-center py-12">
                      <div class="text-gray-400 mb-4">
                          <svg class="w-16 h-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                      </div>
                      <h3 class="text-lg font-medium text-gray-900 mb-2">All caught up!</h3>
                      <p class="text-gray-500">No documents pending review</p>
                  </div>
              `;
              return;
          }

          documents.forEach(doc => {
              const reviewDiv = document.createElement('div');
              reviewDiv.className = 'bg-white border border-gray-200 rounded-lg p-6';

              reviewDiv.innerHTML = `
                  <div class="flex items-start space-x-4">
                      <div class="flex-shrink-0">
                          <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                              <span class="text-2xl">📄</span>
                          </div>
                      </div>
                      <div class="flex-1 min-w-0">
                          <div class="flex items-center justify-between mb-2">
                              <h4 class="text-lg font-medium text-gray-900">${formatDocumentType(doc.document_type)}</h4>
                              <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">Pending</span>
                          </div>
                          <div class="text-sm text-gray-600 mb-4">
                              <p><strong>Instructor:</strong> ${doc.instructor?.full_name || 'Unknown'} (${doc.instructor?.email || 'No email'})</p>
                              <p><strong>Uploaded:</strong> ${new Date(doc.upload_date).toLocaleString()}</p>
                              <p><strong>Original filename:</strong> ${doc.original_filename}</p>
                              ${doc.notes ? `<p><strong>Notes:</strong> ${doc.notes}</p>` : ''}
                              ${doc.expiry_date ? `<p><strong>Expires:</strong> ${new Date(doc.expiry_date).toLocaleDateString()}</p>` : ''}
                          </div>
                          <div class="flex items-center space-x-4">
                              <button onclick="viewDocumentForReview('${doc.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">
                                  👁️ View Document
                              </button>
                              <button onclick="approveDocument('${doc.id}')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">
                                  ✅ Approve
                              </button>
                              <button onclick="rejectDocument('${doc.id}')" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm">
                                  ❌ Reject
                              </button>
                          </div>
                      </div>
                  </div>
              `;

              pendingList.appendChild(reviewDiv);
          });
      }

      function updatePendingCount(count) {
          document.getElementById('pending-count').textContent = `${count} pending`;
      }

      async function approveDocument(documentId) {
          const notes = prompt('Approval notes (optional):');

          try {
              const { error } = await supabase
                  .from('documents')
                  .update({
                      status: 'approved',
                      reviewed_by: currentUser.id,
                      reviewed_date: new Date().toISOString(),
                      review_notes: notes || null
                  })
                  .eq('id', documentId);

              if (error) throw error;

              alert('Document approved successfully!');
              loadPendingDocuments(); // Refresh the queue

          } catch (error) {
              console.error('Error approving document:', error);
              alert('Failed to approve document: ' + error.message);
          }
      }

      async function rejectDocument(documentId) {
          const notes = prompt('Rejection reason (required):');
          if (!notes) {
              alert('Please provide a reason for rejection');
              return;
          }

          try {
              const { error } = await supabase
                  .from('documents')
                  .update({
                      status: 'rejected',
                      reviewed_by: currentUser.id,
                      reviewed_date: new Date().toISOString(),
                      review_notes: notes
                  })
                  .eq('id', documentId);

              if (error) throw error;

              alert('Document rejected. Instructor will be notified.');
              loadPendingDocuments(); // Refresh the queue

          } catch (error) {
              console.error('Error rejecting document:', error);
              alert('Failed to reject document: ' + error.message);
          }
      }

      // Document viewer functions
      async function viewDocument(documentId) {
          try {
              const { data: document, error } = await supabase
                  .from('documents')
                  .select('*')
                  .eq('id', documentId)
                  .single();

              if (error) throw error;

              showDocumentViewer(document);

          } catch (error) {
              console.error('Error loading document:', error);
              alert('Failed to load document');
          }
      }

      async function viewDocumentForReview(documentId) {
          await viewDocument(documentId);
      }

      async function showDocumentViewer(document) {
          try {
              // Get public URL for the document
              const { data: { publicUrl } } = supabase.storage
                  .from('instructor-documents')
                  .getPublicUrl(document.file_path);

              // Update modal title
              document.getElementById('viewer-document-title').textContent = formatDocumentType(document.document_type);

              // Show document content
              const viewerContent = document.getElementById('document-viewer-content');
              const fileExt = document.original_filename.split('.').pop().toLowerCase();

              if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                  // Image file
                  viewerContent.innerHTML = `
                      <img src="${publicUrl}" alt="${document.document_type}" class="max-w-full max-h-full object-contain rounded-lg shadow-lg">
                  `;
              } else if (fileExt === 'pdf') {
                  // PDF file
                  viewerContent.innerHTML = `
                      <iframe src="${publicUrl}" class="w-full h-96 border rounded-lg"></iframe>
                      <div class="mt-4 text-center">
                          <a href="${publicUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                              📄 Open PDF in New Tab
                          </a>
                      </div>
                  `;
              } else {
                  // Other file types
                  viewerContent.innerHTML = `
                      <div class="text-center py-8">
                          <div class="text-gray-400 mb-4">
                              <svg class="w-16 h-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                          </div>
                          <h3 class="text-lg font-medium text-gray-900 mb-2">Preview not available</h3>
                          <p class="text-gray-500 mb-4">File type: ${fileExt.toUpperCase()}</p>
                          <a href="${publicUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                              📥 Download File
                          </a>
                      </div>
                  `;
              }

              // Show modal
              document.getElementById('documentViewerModal').classList.remove('hidden');
              document.getElementById('documentViewerModal').classList.add('flex');

          } catch (error) {
              console.error('Error showing document:', error);
              alert('Failed to display document');
          }
      }

      function hideDocumentViewer() {
          document.getElementById('documentViewerModal').classList.add('hidden');
          document.getElementById('documentViewerModal').classList.remove('flex');
      }

      async function deleteDocument(documentId) {
          if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
              return;
          }

          try {
              // Get document info first
              const { data: document, error: fetchError } = await supabase
                  .from('documents')
                  .select('file_path')
                  .eq('id', documentId)
                  .single();

              if (fetchError) throw fetchError;

              // Delete from storage
              const { error: storageError } = await supabase.storage
                  .from('instructor-documents')
                  .remove([document.file_path]);

              if (storageError) console.warn('Storage deletion warning:', storageError);

              // Delete from database
              const { error: dbError } = await supabase
                  .from('documents')
                  .delete()
                  .eq('id', documentId);

              if (dbError) throw dbError;

              alert('Document deleted successfully');
              loadMyDocuments(); // Refresh the list

          } catch (error) {
              console.error('Error deleting document:', error);
              alert('Failed to delete document: ' + error.message);
          }
      }

      // Income and Expense Categories (defined early to avoid initialization errors)
      const incomeCategories = [
        'Driving Lessons',
        'Theory Test Training',
        'Intensive Courses',
        'Pass Plus Courses',
        'Refresher Lessons',
        'Motorway Lessons',
        'Other Income'
      ];

      const expenseCategories = [
        'Fuel',
        'Vehicle Maintenance',
        'Insurance',
        'Vehicle Tax',
        'MOT',
        'Equipment',
        'Marketing',
        'Training & Development',
        'Office Supplies',
        'Phone & Internet',
        'Professional Fees',
        'Other Expenses'
      ];

      let currentDate = dayjs();

      // Page navigation
      function showPage(pageId, sourceEvent = null) {
        // Hide all pages
        document.querySelectorAll('.page-content').forEach(page => {
          page.classList.add('hidden');
        });
        
        // Show selected page
        document.getElementById(pageId + '-page').classList.remove('hidden');
        
        // Update page title
        const titles = {
          'home': 'Dashboard',
          'calendar': 'Calendar',
          'learners': 'Learners',
          'finances': 'Finances',
          'documents': 'Documents',
          'document-review': 'Admin Review',
          'my-details': 'My Details'
        };
        document.getElementById('page-title').textContent = titles[pageId];
        
        // Initialize page-specific functionality
        if (pageId === 'my-details') {
          initMyDetailsPage();
        } else if (pageId === 'learners') {
          loadLearners();
        } else if (pageId === 'finances') {
          loadFinances();
        } else if (pageId === 'documents') {
          loadMyDocuments();
        } else if (pageId === 'document-review') {
          loadPendingDocuments();
        }
        
        // Update active nav
        document.querySelectorAll('nav button').forEach(btn => {
          btn.classList.remove('active', 'bg-green-600', 'text-white');
          btn.classList.add('text-gray-700', 'hover:bg-gray-100');
        });
        
        // Find and highlight the correct button
        let targetButton;
        if (sourceEvent) {
          // Find the actual button element (in case we clicked on icon or span)
          targetButton = sourceEvent.target.closest('button');
        } else {
          targetButton = document.querySelector(`button[onclick="showPage('${pageId}')"]`);
        }
        
        if (targetButton) {
          targetButton.classList.add('active', 'bg-green-600', 'text-white');
          targetButton.classList.remove('text-gray-700', 'hover:bg-gray-100');
        }
        
        // Load calendar if calendar page
        if (pageId === 'calendar') {
          renderCalendar();
        }
      }

      // Calendar functions
      function getMonday(date) {
        const day = date.day();
        return date.subtract(day === 0 ? 6 : day - 1, 'day');
      }

      function renderCalendar() {
        console.log('renderCalendar called with currentDate:', currentDate.format('YYYY-MM-DD'));
        const monday = getMonday(currentDate);
        console.log('Monday of week:', monday.format('YYYY-MM-DD'));
        document.getElementById('current-month-year').textContent = monday.format('MMMM YYYY');
        
        // Update days header with dates
        const daysHeader = document.getElementById('calendar-days-header');
        let headerHtml = '<div class="w-14"></div>';
        
        const dayNames = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
        for (let i = 0; i < 7; i++) {
          const day = monday.add(i, 'day');
          const isToday = day.format('YYYY-MM-DD') === dayjs().format('YYYY-MM-DD');
          headerHtml += `
            <div class="text-center py-2 border-l border-gray-200">
              <div class="text-xs text-gray-500 mb-1">${dayNames[i]}</div>
              <div class="text-lg font-medium ${isToday ? 'text-green-600' : 'text-gray-900'}">${day.format('D')}</div>
            </div>
          `;
        }
        daysHeader.innerHTML = headerHtml;
        console.log('Updated day headers for week starting:', monday.format('YYYY-MM-DD'));
        
        // Render calendar grid
        renderCalendarGrid(monday);
      }

      function renderCalendarGrid(monday) {
        const calendarBody = document.getElementById('calendar-body');
        
        // Get working hours from preferences (default to 6-22 if not set)
        const startTime = document.getElementById('start-time')?.value || '06:00';
        const endTime = document.getElementById('end-time')?.value || '22:00';
        const startHour = parseInt(startTime.split(':')[0]);
        const endHour = parseInt(endTime.split(':')[0]);
        
        // Get working days from preferences - default to weekdays if not set
        const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const defaultWorkingDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
        const workingDays = preferences?.working_days 
          ? dayNames.filter(day => preferences.working_days[day] === true)
          : defaultWorkingDays;
        console.log('Working days:', workingDays);
        console.log('All preferences:', preferences);
        
        // Check if mobile view
        const isMobile = window.innerWidth < 768;
        let gridHtml = '';
        
        if (isMobile) {
          // Mobile: Show single day view
          const currentDay = currentDate;
          const dayName = currentDay.format('dddd').toLowerCase();
          const dayDate = currentDay.format('MMMM D, YYYY');
          const isToday = currentDay.isSame(dayjs(), 'day');
          const isWorkingDay = workingDays.includes(dayName);
          
          gridHtml = '<div class="mobile-calendar-day">';
          
          // Mobile day header with navigation
          gridHtml += '<div class="mobile-day-header">';
          gridHtml += '<button class="mobile-day-nav" onclick="navigateDay(-1)">‹</button>';
          gridHtml += `<div class="mobile-day-info ${isToday ? 'text-blue-600' : ''}">`;
          gridHtml += `<div class="mobile-day-name">${currentDay.format('dddd')}</div>`;
          gridHtml += `<div class="mobile-day-date">${dayDate}</div>`;
          if (!isWorkingDay) {
            gridHtml += '<div class="text-red-500 text-sm">Not Available</div>';
          }
          gridHtml += '</div>';
          gridHtml += '<button class="mobile-day-nav" onclick="navigateDay(1)">›</button>';
          gridHtml += '</div>';
          
          // Mobile time slots
          gridHtml += '<div class="mobile-time-slots">';
          if (isWorkingDay) {
            for (let hour = startHour; hour <= endHour; hour++) {
              const timeStr = `${hour.toString().padStart(2, '0')}:00`;
              gridHtml += `<div class="mobile-time-slot" data-day="0" data-hour="${hour}" onclick="handleCalendarCellClick('${currentDay.format('YYYY-MM-DD')}', ${hour})">`;
              gridHtml += `<div class="mobile-time">${timeStr}</div>`;
              gridHtml += '<div class="mobile-slot-content">Available</div>';
              gridHtml += '</div>';
            }
          } else {
            gridHtml += '<div class="text-center py-8 text-gray-500">No lessons available on this day</div>';
          }
          gridHtml += '</div>';
          gridHtml += '</div>';
          
        } else {
          // Desktop: Show full week grid
          gridHtml = '<div class="grid grid-cols-8">';
          
          // Time slots (based on working hours)
          for (let hour = startHour; hour <= endHour; hour++) {
            // Time column
            gridHtml += `<div class="w-14 text-right pr-2 py-2 text-xs text-gray-400 border-t border-gray-200">${hour.toString().padStart(2, '0')}:00</div>`;
            
            // Day columns
            for (let day = 0; day < 7; day++) {
              const dayName = dayNames[day];
              const isWorkingDay = workingDays.includes(dayName);
              const cellClass = isWorkingDay 
                ? 'relative h-12 border-t border-l border-gray-200 hover:bg-gray-50 cursor-pointer'
                : 'relative h-12 border-t border-l border-gray-200 bg-gray-100 cursor-not-allowed';
              const dataAttrs = isWorkingDay ? `data-day="${day}" data-hour="${hour}"` : '';
              gridHtml += `<div class="${cellClass}" ${dataAttrs}></div>`;
            }
          }
          
          gridHtml += '</div>';
        }
        
        calendarBody.innerHTML = gridHtml;
        
        // Add click event listeners to calendar cells (desktop only)
        if (!isMobile) {
          const calendarCells = calendarBody.querySelectorAll('[data-day][data-hour]');
          calendarCells.forEach(cell => {
            cell.addEventListener('click', (e) => {
              // Only trigger if clicking on empty space (not on existing lesson)
              if (e.target === cell) {
                const day = parseInt(cell.getAttribute('data-day'));
                const hour = parseInt(cell.getAttribute('data-hour'));
                const clickedDate = monday.add(day, 'day');
                handleCalendarCellClick(clickedDate.format('YYYY-MM-DD'), hour);
              }
            });
          });
        }
        
        // Fetch and render lessons after DOM is ready
        setTimeout(() => {
          fetchLessons(monday);
        }, 50);
      }
      
      // Mobile day navigation function
      function navigateDay(direction) {
        currentDate = currentDate.add(direction, 'day');
        renderCalendar();
      }

      async function fetchLessons(monday) {
        console.log('fetchLessons called for week starting:', monday.format('YYYY-MM-DD'));
        const sunday = monday.add(6, 'day');
        console.log('Fetching lessons from', monday.format('YYYY-MM-DD'), 'to', sunday.format('YYYY-MM-DD'));
        
        try {
          // Test query - fetch ALL lessons to see if connection works
          console.log('Testing: Fetching ALL lessons...');
          const { data: allLessons, error: allLessonsError } = await supabase
            .from('lessons')
            .select('*');
          
          console.log('All lessons test result:', { data: allLessons, error: allLessonsError });
          if (allLessons && allLessons.length > 0) {
            console.log('Sample lesson data:', allLessons[0]);
          }
          
          // First, fetch all pupils to create a lookup map
          console.log('Fetching pupils...');
          const { data: pupils, error: pupilsError } = await supabase
            .from('pupils')
            .select('id, full_name');

          if (pupilsError) {
            console.error('Error fetching pupils:', pupilsError);
            return;
          }

          console.log('Pupils fetched:', pupils);

          // Create pupil lookup map
          const pupilMap = new Map();
          pupils.forEach(pupil => {
            pupilMap.set(pupil.id, pupil.full_name);
          });
          console.log('Pupil map created:', pupilMap);

          // Then fetch lessons for the week
          console.log('Fetching lessons...');
          console.log('Query parameters:', {
            from_date: monday.format('YYYY-MM-DD'),
            to_date: sunday.format('YYYY-MM-DD'),
            instructor_id: currentUser?.id
          });
          
          let lessonsQuery = supabase
            .from('lessons')
            .select('*')
            .gte('lesson_date', monday.format('YYYY-MM-DD'))
            .lte('lesson_date', sunday.format('YYYY-MM-DD'));

          // Filter by instructor if currentUser is available, otherwise show all lessons
          if (currentUser?.id) {
            lessonsQuery = lessonsQuery.eq('instructor_id', currentUser.id);
          }
          
          const { data: lessons, error: lessonsError } = await lessonsQuery;

          console.log('Supabase query result:', { data: lessons, error: lessonsError });

          if (lessonsError) {
            console.error('Error fetching lessons:', lessonsError);
            return;
          }

          console.log('Lessons fetched:', lessons);
          console.log('Number of lessons found:', lessons?.length || 0);

          // Debug each lesson individually
          if (lessons && lessons.length > 0) {
            lessons.forEach((lesson, index) => {
              console.log(`Lesson ${index + 1}:`, {
                id: lesson.id,
                pupil_id: lesson.pupil_id,
                lesson_date: lesson.lesson_date,
                start_time: lesson.start_time,
                duration: lesson.duration,
                status: lesson.status
              });
            });
          } else {
            console.log('No lessons returned from database query');
          }

          // Render lessons with pupil names
          lessons.forEach(lesson => {
            const pupilName = pupilMap.get(lesson.pupil_id) || 'Unknown Pupil';
            lesson.pupil_name = pupilName;
            console.log('Rendering lesson:', lesson);
            renderLesson(lesson, monday);
          });
          
        } catch (error) {
          console.error('Error in fetchLessons:', error);
        }
      }

      function renderLesson(lesson, monday) {
        console.log('renderLesson called with:', lesson);
        const start = dayjs(`${lesson.lesson_date}T${lesson.start_time}`);
        const dayIndex = start.day() === 0 ? 6 : start.day() - 1; // Convert Sunday=0 to index 6
        const hour = start.hour();
        
        console.log('Lesson timing:', {
          date: lesson.lesson_date,
          time: lesson.start_time,
          dayIndex,
          hour,
          startDay: start.day()
        });
        
        // Calculate duration in hours
        const durationHours = lesson.duration / 60;
        
        // Get pupil name from the mapped data
        const pupilName = lesson.pupil_name || 'Unknown Pupil';
        console.log('Pupil name:', pupilName);
        
        const cell = document.querySelector(`[data-day="${dayIndex}"][data-hour="${hour}"]`);
        console.log('Looking for cell with data-day=' + dayIndex + ' data-hour=' + hour);
        console.log('Cell found:', cell ? 'YES' : 'NO');
        
        if (cell) {
          const lessonEl = document.createElement('div');
          
          // Handle different lesson types
          if (lesson.lesson_type === 'unavailable') {
            lessonEl.className = 'absolute inset-0 p-1 text-xs rounded border-l-4 cursor-pointer bg-gray-300 border-gray-500 text-gray-700';
            lessonEl.style.height = `${durationHours * 48}px`;
            lessonEl.innerHTML = `
              <div class="font-semibold truncate">Unavailable</div>
              <div>${start.format('HH:mm')}</div>
            `;
          } else {
            lessonEl.className = `absolute inset-0 p-1 text-xs rounded border-l-4 cursor-pointer ${
              lesson.status === 'completed' ? 'bg-green-100 border-green-500' :
              lesson.status === 'cancelled' ? 'bg-red-100 border-red-500' :
              'bg-blue-100 border-blue-500'
            }`;
            lessonEl.style.height = `${durationHours * 48}px`;
            
            // Extract postcode from pickup_address (last part after last space)
             const addressParts = lesson.pickup_address ? lesson.pickup_address.split(' ') : [];
             const postcode = addressParts.length > 0 ? addressParts[addressParts.length - 1] : '';
            
             lessonEl.innerHTML = `
               <div class="font-semibold truncate">${pupilName}</div>
               <div>${start.format('HH:mm')}</div>
               ${postcode ? `<div class="text-xs text-gray-600">${postcode}</div>` : ''}
             `;
           }
          
          lessonEl.addEventListener('click', () => showLessonDetails(lesson));
          cell.appendChild(lessonEl);
          console.log('Lesson element added to calendar for:', pupilName);
        } else {
          console.error('Could not find calendar cell for dayIndex:', dayIndex, 'hour:', hour);
        }
      }

      async function showLessonDetails(lesson) {
        const start = dayjs(`${lesson.lesson_date}T${lesson.start_time}`);
        
        // Handle unavailable lessons differently
        if (lesson.lesson_type === 'unavailable') {
          document.getElementById('modal-pupil-name').textContent = 'Unavailable';
          document.getElementById('modal-instructor-name').textContent = 'N/A';
          document.getElementById('modal-lesson-datetime').textContent = start.format('ddd, D MMM YYYY, HH:mm');
          document.getElementById('modal-lesson-duration').textContent = `${lesson.duration} minutes`;
          document.getElementById('modal-pickup-address').textContent = 'N/A';
          document.getElementById('modal-lesson-notes').textContent = lesson.lesson_notes || 'Time slot marked as unavailable';
        } else {
          // Fetch instructor name (we already have pupil name from mapping)
          const { data: instructorData, error: instructorError } = await supabase
            .from('instructors')
            .select('full_name')
            .eq('id', lesson.instructor_id)
            .single();

          if (instructorError) console.error('Error fetching instructor:', instructorError.message);

          const pupilName = lesson.pupil_name || 'Unknown Pupil';
          const instructorName = instructorData?.full_name || 'Unknown Instructor';

          // Update modal content
          document.getElementById('modal-pupil-name').textContent = pupilName;
          document.getElementById('modal-instructor-name').textContent = instructorName;
          document.getElementById('modal-lesson-datetime').textContent = start.format('ddd, D MMM YYYY, HH:mm');
          document.getElementById('modal-lesson-duration').textContent = `${lesson.duration} minutes`;
          document.getElementById('modal-pickup-address').textContent = lesson.pickup_address || 'N/A';
          document.getElementById('modal-lesson-notes').textContent = lesson.lesson_notes || 'N/A';
        }

        // Show modal
        document.getElementById('lesson-modal').classList.remove('hidden');
      }

      // My Details tab functionality
      function showDetailsTab(tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll('.details-tab-content');
        tabContents.forEach(content => {
          content.classList.add('hidden');
        });
        
        // Remove active class from all tabs
        const tabs = document.querySelectorAll('.details-tab');
        tabs.forEach(tab => {
          tab.classList.remove('border-green-500', 'text-green-600');
          tab.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Show selected tab content
        const selectedContent = document.getElementById(tabName + '-tab');
        if (selectedContent) {
          selectedContent.classList.remove('hidden');
        }
        
        // Add active class to selected tab
        const selectedTab = document.querySelector(`[onclick="showDetailsTab('${tabName}')"]`);
        if (selectedTab) {
          selectedTab.classList.remove('border-transparent', 'text-gray-500');
          selectedTab.classList.add('border-green-500', 'text-green-600');
        }
      }
      
      // My Details functionality
      let currentUser = null;
      let vehicles = [];
      let qualifications = [];
      let areas = [];
      let preferences = null;
      
      // Initialize My Details page when shown
      async function initMyDetailsPage() {
        try {
          // Show personal details tab by default
          showDetailsTab('personal');
          
          // Load user data - this will set currentUser when instructor is loaded
          await loadInstructorData();
          await loadVehicles();
          await loadQualifications();
          await loadAreas();
          await loadPreferences();
          
        } catch (error) {
          console.error('Error initializing My Details page:', error);
        }
      }
      
      // Load instructor personal data
      async function loadInstructorData() {
        try {
          // First check authentication
          const user = await checkAuthentication();
          if (!user) return;

          // Load instructor data for authenticated user
          const { data: instructor, error } = await supabase
            .from('instructors')
            .select('*')
            .eq('user_id', user.id)
            .single();

          if (error) {
            if (error.code === 'PGRST116') {
              // No instructor record found, create one
              console.log('No instructor record found, creating one...');
              const { data: newInstructor, error: createError } = await supabase
                .from('instructors')
                .insert([{
                  user_id: user.id,
                  email: user.email,
                  full_name: user.user_metadata?.full_name || user.email,
                  first_name: user.user_metadata?.first_name || '',
                  last_name: user.user_metadata?.last_name || '',
                  name: user.user_metadata?.full_name || user.email,
                }])
                .select()
                .single();

              if (createError) {
                console.error('Error creating instructor:', createError);
                return;
              }

              currentUser = {
                id: newInstructor.id,
                auth_id: user.id,
                email: user.email,
                ...newInstructor
              };
              populateInstructorForm(newInstructor);
            } else {
              console.error('Error loading instructor:', error);
              return;
            }
          } else {
            currentUser = {
              id: instructor.id,
              auth_id: user.id,
              email: user.email,
              ...instructor
            };
            populateInstructorForm(instructor);
          }

          console.log('✅ Instructor loaded, currentUser set to:', currentUser);

        } catch (error) {
          console.error('Error loading instructor data:', error);
        }
      }

      function populateInstructorForm(instructor) {
        // Populate form fields
        document.getElementById('first-name').value = instructor.first_name || '';
        document.getElementById('last-name').value = instructor.last_name || '';
        document.getElementById('email').value = instructor.email || '';
        document.getElementById('phone').value = instructor.phone || '';
        document.getElementById('address-line1').value = instructor.address_line_1 || '';
        document.getElementById('address-line2').value = instructor.address_line_2 || '';
        document.getElementById('city').value = instructor.city || '';
        document.getElementById('postcode').value = instructor.postcode || '';
        document.getElementById('date-of-birth').value = instructor.date_of_birth || '';
        document.getElementById('emergency-contact-name').value = instructor.emergency_contact_name || '';
        document.getElementById('emergency-contact-phone').value = instructor.emergency_contact_phone || '';
      }
      
      // Load vehicles from Supabase
      async function loadVehicles() {
        try {
          if (!currentUser?.id) return;
          
          const { data: vehicleData, error } = await supabase
            .from('vehicles')
            .select('*')
            .eq('instructor_id', currentUser.id);

          if (error) {
            console.error('Error loading vehicles:', error);
            vehicles = [];
          } else {
            vehicles = vehicleData || [];
          }
          
          renderVehicles();
        } catch (error) {
          console.error('Error loading vehicles:', error);
          vehicles = [];
        }
      }

      function renderVehicles() {
        const vehiclesList = document.getElementById('vehicles-list');
        if (!vehiclesList) return;
        
        vehiclesList.innerHTML = '';
        
        vehicles.forEach(vehicle => {
          const vehicleDiv = document.createElement('div');
          vehicleDiv.className = 'border border-gray-200 rounded-lg p-4';
          vehicleDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h5 class="font-medium text-gray-900">${vehicle.make} ${vehicle.model || ''}</h5>
                <p class="text-sm text-gray-600">Registration: ${vehicle.registration}</p>
                <p class="text-sm text-gray-600">Fuel: ${vehicle.fuel_type}, Transmission: ${vehicle.transmission || 'Manual'}</p>
              </div>
              <button onclick="removeVehicle('${vehicle.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 text-sm border border-red-600 rounded">
                Remove
              </button>
            </div>
          `;
          vehiclesList.appendChild(vehicleDiv);
        });
      }

      // Update financial summary cards
      function updateFinancialSummary() {
        const transactions = window.allTransactions || [];
        const currentMonth = new Date().toISOString().slice(0, 7);
        
        const totalIncome = transactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        const totalExpenses = transactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        const netProfit = totalIncome - totalExpenses;
        
        const thisMonthNet = transactions
          .filter(t => t.date.startsWith(currentMonth))
          .reduce((sum, t) => {
            return t.type === 'income' 
              ? sum + parseFloat(t.amount)
              : sum - parseFloat(t.amount);
          }, 0);

        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const netProfitEl = document.getElementById('netProfit');
        const thisMonthNetEl = document.getElementById('thisMonthNet');
        
        if (totalIncomeEl) totalIncomeEl.textContent = `£${totalIncome.toFixed(2)}`;
        if (totalExpensesEl) totalExpensesEl.textContent = `£${totalExpenses.toFixed(2)}`;
        if (netProfitEl) netProfitEl.textContent = `£${netProfit.toFixed(2)}`;
        if (thisMonthNetEl) thisMonthNetEl.textContent = `£${thisMonthNet.toFixed(2)}`;
      }

      // Render transactions table
      function renderTransactionsTable() {
        const transactions = getFilteredTransactions();
        const tableBody = document.getElementById('transactionsTableBody');
        
        if (!tableBody) return;
        
        if (transactions.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No transactions found</td></tr>';
          return;
        }

        // Group transactions by category and type
        const grouped = {};
        let totalIncome = 0;
        let totalExpenses = 0;

        transactions.forEach(transaction => {
          const key = `${transaction.type}-${transaction.category}`;
          if (!grouped[key]) {
            grouped[key] = {
              type: transaction.type,
              category: transaction.category,
              transactions: [],
              total: 0
            };
          }
          grouped[key].transactions.push(transaction);
          grouped[key].total += parseFloat(transaction.amount);
          
          if (transaction.type === 'income') {
            totalIncome += parseFloat(transaction.amount);
          } else {
            totalExpenses += parseFloat(transaction.amount);
          }
        });

        let html = '';
        
        // Income sections
        Object.values(grouped)
          .filter(group => group.type === 'income')
          .forEach(group => {
            html += `
              <tr class="bg-green-50">
                <td class="px-4 py-3 font-semibold text-green-800">${group.category}</td>
                <td class="px-4 py-3 text-center text-green-600">${group.transactions.length}</td>
                <td class="px-4 py-3 text-right font-semibold text-green-600">£${group.total.toFixed(2)}</td>
                <td class="px-4 py-3"></td>
                <td class="px-4 py-3"></td>
                <td class="px-4 py-3"></td>
              </tr>
            `;
            
            group.transactions.forEach(transaction => {
              html += `
                <tr class="border-l-4 border-green-200">
                  <td class="px-8 py-2 text-sm text-gray-600">${transaction.description || '-'}</td>
                  <td class="px-4 py-2 text-sm text-center">1</td>
                  <td class="px-4 py-2 text-sm text-right">£${parseFloat(transaction.amount).toFixed(2)}</td>
                  <td class="px-4 py-2 text-sm">${new Date(transaction.date).toLocaleDateString()}</td>
                  <td class="px-4 py-2 text-sm">${transaction.tax_category || '-'}</td>
                  <td class="px-4 py-2 text-sm">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                      Income
                    </span>
                  </td>
                </tr>
              `;
            });
          });

        // Expense sections
        Object.values(grouped)
          .filter(group => group.type === 'expense')
          .forEach(group => {
            html += `
              <tr class="bg-red-50">
                <td class="px-4 py-3 font-semibold text-red-800">${group.category}</td>
                <td class="px-4 py-3 text-center text-red-600">${group.transactions.length}</td>
                <td class="px-4 py-3 text-right font-semibold text-red-600">£${group.total.toFixed(2)}</td>
                <td class="px-4 py-3"></td>
                <td class="px-4 py-3"></td>
                <td class="px-4 py-3"></td>
              </tr>
            `;
            
            group.transactions.forEach(transaction => {
              html += `
                <tr class="border-l-4 border-red-200">
                  <td class="px-8 py-2 text-sm text-gray-600">${transaction.description || '-'}</td>
                  <td class="px-4 py-2 text-sm text-center">1</td>
                  <td class="px-4 py-2 text-sm text-right">£${parseFloat(transaction.amount).toFixed(2)}</td>
                  <td class="px-4 py-2 text-sm">${new Date(transaction.date).toLocaleDateString()}</td>
                  <td class="px-4 py-2 text-sm">${transaction.tax_category || '-'}</td>
                  <td class="px-4 py-2 text-sm">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                      Expense
                    </span>
                  </td>
                </tr>
              `;
            });
          });

        // Totals row
        const netProfit = totalIncome - totalExpenses;
        html += `
          <tr class="bg-gray-100 font-bold">
            <td class="px-4 py-3">TOTALS</td>
            <td class="px-4 py-3 text-center">${transactions.length}</td>
            <td class="px-4 py-3 text-right">£${netProfit.toFixed(2)}</td>
            <td class="px-4 py-3"></td>
            <td class="px-4 py-3"></td>
            <td class="px-4 py-3">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                netProfit >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
              }">
                ${netProfit >= 0 ? 'Profit' : 'Loss'}
              </span>
            </td>
          </tr>
        `;

        tableBody.innerHTML = html;
      }

      // Get filtered transactions
      function getFilteredTransactions() {
        let transactions = window.allTransactions || [];
        
        const dateFrom = document.getElementById('dateFrom')?.value;
        const dateTo = document.getElementById('dateTo')?.value;
        const categoryFilter = document.getElementById('categoryFilter')?.value;
        
        if (dateFrom) {
          transactions = transactions.filter(t => t.date >= dateFrom);
        }
        
        if (dateTo) {
          transactions = transactions.filter(t => t.date <= dateTo);
        }
        
        if (categoryFilter && categoryFilter !== 'all') {
          transactions = transactions.filter(t => t.category === categoryFilter);
        }
        
        return transactions;
      }

      // Modal functions
      function showAddTransactionModal() {
        document.getElementById('addTransactionModal').classList.remove('hidden');
        document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        updateCategoryOptions();
      }

      function hideAddTransactionModal() {
        document.getElementById('addTransactionModal').classList.add('hidden');
        document.getElementById('addTransactionForm').reset();
      }

      function updateCategoryOptions() {
        const typeSelect = document.getElementById('transactionType');
        const categorySelect = document.getElementById('transactionCategory');
        
        if (!typeSelect || !categorySelect) return;
        
        const selectedType = typeSelect.value;
        const categories = selectedType === 'income' ? incomeCategories : expenseCategories;
        
        categorySelect.innerHTML = '';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categorySelect.appendChild(option);
        });
      }

      async function handleAddTransaction(event) {
        event.preventDefault();
        
        if (!currentUser?.id) {
          alert('No user session found');
          return;
        }
        
        const formData = new FormData(event.target);
        const transaction = {
          instructor_id: currentUser.id,
          type: formData.get('type'),
          category: formData.get('category'),
          amount: parseFloat(formData.get('amount')),
          description: formData.get('description'),
          date: formData.get('date'),
          tax_category: formData.get('tax_category')
        };
        
        try {
          // Save to Supabase
          const { data, error } = await supabase
            .from('transactions')
            .insert([transaction])
            .select();
          
          if (error) {
            console.error('Error saving transaction:', error);
            alert('Failed to save transaction: ' + error.message);
            return;
          }
          
          console.log('Transaction saved successfully:', data);
          alert('Transaction added successfully!');
          
          // Reload financial data
          await loadFinancialData();
          
        } catch (error) {
          console.error('Error saving transaction:', error);
          alert('Failed to save transaction');
        }
        
        hideAddTransactionModal();
      }

      function populateMonthlyDropdown() {
        const monthlySelect = document.getElementById('monthlySelect');
        if (!monthlySelect) return;
        
        const months = [];
        const currentDate = new Date();
        
        for (let i = 0; i < 12; i++) {
          const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
          months.push({
            value: date.toISOString().slice(0, 7),
            label: date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })
          });
        }
        
        monthlySelect.innerHTML = '<option value="">Select Month</option>';
        months.forEach(month => {
          const option = document.createElement('option');
          option.value = month.value;
          option.textContent = month.label;
          monthlySelect.appendChild(option);
        });
      }

      function showMonthlyBreakdown() {
        const selectedMonth = document.getElementById('monthlySelect')?.value;
        if (!selectedMonth) {
          alert('Please select a month first');
          return;
        }
        
        const monthTransactions = (window.allTransactions || [])
          .filter(t => t.date.startsWith(selectedMonth));
        
        const income = monthTransactions.filter(t => t.type === 'income');
        const expenses = monthTransactions.filter(t => t.type === 'expense');
        
        const totalIncome = income.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        const netProfit = totalIncome - totalExpenses;
        
        // Update modal content
        document.getElementById('modalMonthTitle').textContent = `Monthly Breakdown - ${new Date(selectedMonth + '-01').toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}`;
        document.getElementById('modalIncomeTotal').textContent = `£${totalIncome.toFixed(2)}`;
        document.getElementById('modalExpenseTotal').textContent = `£${totalExpenses.toFixed(2)}`;
        document.getElementById('modalNetProfit').textContent = `£${netProfit.toFixed(2)}`;
        
        // Show modal
        document.getElementById('monthlyBreakdownModal').classList.remove('hidden');
      }

      function hideMonthlyBreakdown() {
        document.getElementById('monthlyBreakdownModal').classList.add('hidden');
      }

      function exportFinancialData() {
        const transactions = window.allTransactions || [];
        if (transactions.length === 0) {
          alert('No transactions to export');
          return;
        }
        
        const csvContent = [
          ['Date', 'Type', 'Category', 'Description', 'Amount', 'Tax Category'].join(','),
          ...transactions.map(t => [
            t.date,
            t.type,
            t.category,
            `"${t.description || ''}"`,,
            t.amount,
            t.tax_category || ''
          ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `financial-data-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      function applyFilters() {
        renderTransactionsTable();
      }
      
      // Postcode validation using postcodes.io API
      let postcodeCache = new Map();
      
      async function validatePostcode(postcode) {
        // Clean the postcode (remove spaces, convert to uppercase)
        const cleanPostcode = postcode.replace(/\s/g, '').toUpperCase();
        
        // Check cache first
        if (postcodeCache.has(cleanPostcode)) {
          return postcodeCache.get(cleanPostcode);
        }
        
        try {
          const response = await fetch(`https://api.postcodes.io/postcodes/${cleanPostcode}`);
          const data = await response.json();
          
          const result = {
            valid: response.ok && data.status === 200,
            postcode: data.result?.postcode || cleanPostcode,
            district: data.result?.admin_district || null,
            ward: data.result?.admin_ward || null,
            county: data.result?.admin_county || null,
            country: data.result?.country || null,
            latitude: data.result?.latitude || null,
            longitude: data.result?.longitude || null,
            error: !response.ok ? data.error : null
          };
          
          // Cache the result
          postcodeCache.set(cleanPostcode, result);
          return result;
        } catch (error) {
          console.error('Postcode validation error:', error);
          const result = {
            valid: false,
            postcode: cleanPostcode,
            error: 'Network error - could not validate postcode'
          };
          postcodeCache.set(cleanPostcode, result);
          return result;
        }
      }
      
      function setupPostcodeValidation(inputElement, feedbackElement) {
        let validationTimeout;
        
        inputElement.addEventListener('input', function() {
          const postcode = this.value.trim();
          
          // Clear previous timeout
          clearTimeout(validationTimeout);
          
          // Reset feedback
          feedbackElement.textContent = '';
          feedbackElement.className = 'text-sm mt-1';
          this.classList.remove('border-red-500', 'border-green-500');
          
          // Auto-format postcode as user types
          if (postcode.length > 0) {
            const formatted = formatPostcodeInput(postcode);
            if (formatted !== postcode) {
              this.value = formatted;
            }
          }
          
          if (postcode.length < 5) {
            // Show hint for short inputs
            if (postcode.length > 0 && postcode.length < 3) {
              feedbackElement.textContent = 'UK postcode format: SW1A 1AA';
              feedbackElement.className = 'text-sm mt-1 text-gray-500';
            }
            return; // Don't validate very short inputs
          }
          
          // Show loading state
          feedbackElement.textContent = 'Validating postcode...';
          feedbackElement.className = 'text-sm mt-1 text-gray-500';
          
          // Debounce validation
          validationTimeout = setTimeout(async () => {
            const result = await validatePostcode(postcode);
            
            if (result.valid) {
              this.classList.remove('border-red-500');
              this.classList.add('border-green-500');
              let locationInfo = result.district ? ` in ${result.district}` : '';
              if (result.county && result.county !== result.district) {
                locationInfo += `, ${result.county}`;
              }
              feedbackElement.textContent = `✓ Valid postcode${locationInfo}`;
              feedbackElement.className = 'text-sm mt-1 text-green-600';
              
              // Update the input with the standardized format
              if (result.postcode !== postcode.replace(/\s/g, '').toUpperCase()) {
                this.value = result.postcode;
              }
            } else {
              this.classList.remove('border-green-500');
              this.classList.add('border-red-500');
              feedbackElement.textContent = `✗ ${result.error || 'Invalid postcode'}`;
              feedbackElement.className = 'text-sm mt-1 text-red-600';
            }
          }, 500);
        });
        
        // Handle paste events
        inputElement.addEventListener('paste', function() {
          setTimeout(() => {
            const event = new Event('input', { bubbles: true });
            this.dispatchEvent(event);
          }, 10);
        });
      }
      
      function formatPostcodeInput(input) {
        // Remove all spaces and convert to uppercase
        let cleaned = input.replace(/\s/g, '').toUpperCase();
        
        // Don't format if too short or too long
        if (cleaned.length < 3 || cleaned.length > 7) {
          return input.toUpperCase();
        }
        
        // Basic UK postcode formatting
        if (cleaned.length >= 5) {
          // Insert space before the last 3 characters
          return cleaned.slice(0, -3) + ' ' + cleaned.slice(-3);
        }
        
        return cleaned;
      }
      
      // Initialize financial page
      updateFinancialSummary();
      renderTransactionsTable();
      populateMonthlyDropdown();
      
      // Set up event listeners for financial page
      const addTransactionBtn = document.getElementById('addTransactionBtn');
      const exportBtn = document.getElementById('exportBtn');
      const transactionTypeSelect = document.getElementById('transactionType');
      const addTransactionForm = document.getElementById('addTransactionForm');
      const dateFromInput = document.getElementById('dateFrom');
      const dateToInput = document.getElementById('dateTo');
      const categoryFilterSelect = document.getElementById('categoryFilter');
      const monthlyViewBtn = document.getElementById('monthlyViewBtn');
      
      if (addTransactionBtn) {
        addTransactionBtn.addEventListener('click', showAddTransactionModal);
      }
      
      if (exportBtn) {
        exportBtn.addEventListener('click', exportFinancialData);
      }
      
      if (transactionTypeSelect) {
        transactionTypeSelect.addEventListener('change', updateCategoryOptions);
      }
      
      if (addTransactionForm) {
        addTransactionForm.addEventListener('submit', handleAddTransaction);
      }
      
      if (dateFromInput) {
        dateFromInput.addEventListener('change', applyFilters);
      }
      
      if (dateToInput) {
        dateToInput.addEventListener('change', applyFilters);
      }
      
      if (categoryFilterSelect) {
        categoryFilterSelect.addEventListener('change', applyFilters);
      }
      
      if (monthlyViewBtn) {
        monthlyViewBtn.addEventListener('click', showMonthlyBreakdown);
      }
      
      // Populate category filter dropdown
      if (categoryFilterSelect) {
        const allCategories = [...incomeCategories, ...expenseCategories];
        categoryFilterSelect.innerHTML = '<option value="all">All Categories</option>';
        allCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categoryFilterSelect.appendChild(option);
        });
      }
      
      renderVehicles();
      
      // Load qualifications (demo data)
      async function loadQualifications() {
        try {
          if (!currentUser?.id) return;
          
          const { data: qualificationData, error } = await supabase
            .from('qualifications')
            .select('*')
            .eq('instructor_id', currentUser.id);

          if (error) {
            console.error('Error loading qualifications:', error);
            qualifications = [];
          } else {
            qualifications = qualificationData || [];
          }
          
          renderQualifications();
        } catch (error) {
          console.error('Error loading qualifications:', error);
          qualifications = [];
        }
      }

      function renderQualifications() {
        const qualificationsList = document.getElementById('qualifications-list');
        if (!qualificationsList) return;
        
        qualificationsList.innerHTML = '';
        
        qualifications.forEach(qualification => {
          const qualificationDiv = document.createElement('div');
          qualificationDiv.className = 'border border-gray-200 rounded-lg p-4';
          qualificationDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h5 class="font-medium text-gray-900">${qualification.qualification_type}</h5>
                <p class="text-sm text-gray-600">Number: ${qualification.reference_number || 'N/A'}</p>
                <p class="text-sm text-gray-600">Issue Date: ${qualification.issue_date ? new Date(qualification.issue_date).toLocaleDateString() : 'N/A'}</p>
                <p class="text-sm text-gray-600">Expiry Date: ${qualification.expiry_date ? new Date(qualification.expiry_date).toLocaleDateString() : 'N/A'}</p>
              </div>
              <button onclick="removeQualification('${qualification.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 text-sm border border-red-600 rounded">
                Remove
              </button>
            </div>
          `;
          qualificationsList.appendChild(qualificationDiv);
        });
      }
      
      // Load areas from Supabase
      async function loadAreas() {
        try {
          if (!currentUser?.id) return;
          
          const { data: areaData, error } = await supabase
            .from('areas')
            .select('*')
            .eq('instructor_id', currentUser.id);

          if (error) {
            console.error('Error loading areas:', error);
            areas = [];
          } else {
            areas = areaData || [];
          }
          
          renderAreas();
        } catch (error) {
          console.error('Error loading areas:', error);
          areas = [];
        }
      }

      function renderAreas() {
        const areasList = document.getElementById('areas-list');
        if (!areasList) return;
        
        areasList.innerHTML = '';
        
        areas.forEach(area => {
          const areaDiv = document.createElement('div');
          areaDiv.className = 'border border-gray-200 rounded-lg p-4';
          areaDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h5 class="font-medium text-gray-900">${area.area_name}</h5>
                <p class="text-sm text-gray-600">Postcode: ${area.postcode}</p>
                <p class="text-sm text-gray-600">Additional Charge: £${(area.additional_charge || 0).toFixed(2)}</p>
              </div>
              <button onclick="removeArea('${area.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 text-sm border border-red-600 rounded">
                Remove
              </button>
            </div>
          `;
          areasList.appendChild(areaDiv);
        });
      }
      
      // Load preferences from Supabase
      async function loadPreferences() {
        try {
          if (!currentUser?.id) return;
          
          const { data: preferencesData, error } = await supabase
            .from('preferences')
            .select('*')
            .eq('instructor_id', currentUser.id)
            .single();

          let prefData;
          if (error || !preferencesData) {
            // Create default preferences if none exist
            const defaultPrefs = {
              instructor_id: currentUser.id,
              max_pupils: 20,
              standard_lesson_price: 35.00,
              intensive_lesson_price: 280.00,
              working_hours_start: '06:00:00',
              working_hours_end: '22:00:00',
              working_days: {
                monday: true,
                tuesday: true,
                wednesday: true,
                thursday: true,
                friday: true,
                saturday: false,
                sunday: false
              }
            };
            
            const { data: newPrefs, error: createError } = await supabase
              .from('preferences')
              .insert([defaultPrefs])
              .select()
              .single();
              
            if (createError) {
              console.error('Error creating preferences:', createError);
              return;
            }
            prefData = newPrefs;
          } else {
            prefData = preferencesData;
          }
          
          // Set global preferences variable
          preferences = prefData;
          console.log('Preferences loaded:', prefData);
          
          // Populate preferences form fields
          document.getElementById('lesson-duration').value = '90'; // Default 90 minutes
          document.getElementById('max-pupils').value = prefData.max_pupils || '20';
          document.getElementById('lesson-price').value = prefData.standard_lesson_price || '35.00';
          document.getElementById('intensive-price').value = prefData.intensive_lesson_price || '280.00';
          document.getElementById('start-time').value = prefData.working_hours_start?.substring(0, 5) || '06:00';
          document.getElementById('end-time').value = prefData.working_hours_end?.substring(0, 5) || '22:00';
          document.getElementById('automatic-only').value = 'false';
          document.getElementById('female-only').value = 'false';
          document.getElementById('special-requirements').value = 'Experienced instructor with 15+ years teaching. Specializes in nervous drivers.';
          
          // Set working days checkboxes
          const workingDays = prefData.working_days || {};
          const workingDayCheckboxes = document.querySelectorAll('input[name="working_days"]');
          workingDayCheckboxes.forEach(checkbox => {
            checkbox.checked = workingDays[checkbox.value] === true;
          });
          
          console.log('Preferences loaded:', prefData);
        } catch (error) {
          console.error('Error loading preferences:', error);
        }
      }
      
      // Load and render learners data from Supabase
      async function loadLearners() {
        try {
          if (!currentUser?.id) {
            renderLearners([]);
            return;
          }

          const { data: pupils, error } = await supabase
            .from('pupils')
            .select('*')
            .eq('instructor_id', currentUser.id)
            .order('created_at', { ascending: false });

          if (error) {
            console.error('Error loading learners:', error);
            renderLearners([]);
            return;
          }

          // Get lesson counts for each pupil
          const learnersWithStats = await Promise.all(
            pupils.map(async (pupil) => {
              const { data: lessons, error: lessonsError } = await supabase
                .from('lessons')
                .select('*')
                .eq('pupil_id', pupil.id)
                .eq('status', 'completed');

              const { data: nextLesson, error: nextLessonError } = await supabase
                .from('lessons')
                .select('lesson_date, start_time')
                .eq('pupil_id', pupil.id)
                .eq('status', 'scheduled')
                .order('lesson_date', { ascending: true })
                .limit(1);

              return {
                id: pupil.id,
                name: pupil.full_name || pupil.name || `${pupil.first_name} ${pupil.last_name}`,
                email: pupil.email,
                phone: pupil.phone,
                lessons_completed: lessons?.length || 0,
                next_lesson: nextLesson?.[0] ? `${nextLesson[0].lesson_date} ${nextLesson[0].start_time}` : null,
                status: lessons?.length >= 20 ? 'Test Ready' : 'Active'
              };
            })
          );

          renderLearners(learnersWithStats);
        } catch (error) {
          console.error('Error loading learners:', error);
          renderLearners([]);
        }
      }
      
      function renderLearners(learners) {
        const learnersList = document.getElementById('learners-list');
        learnersList.innerHTML = '';
        
        learners.forEach(learner => {
          const learnerDiv = document.createElement('div');
          learnerDiv.className = 'border border-gray-200 rounded-lg p-4';
          
          const statusColor = learner.status === 'Active' ? 'bg-green-100 text-green-800' : 
                             learner.status === 'Test Ready' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
          
          learnerDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-3">
                  <h5 class="font-medium text-gray-900">${learner.name}</h5>
                  <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${learner.status}</span>
                </div>
                <p class="text-sm text-gray-600 mt-1">${learner.email} | ${learner.phone}</p>
                <p class="text-sm text-gray-600">Lessons completed: ${learner.lessons_completed}</p>
                ${learner.next_lesson ? `<p class="text-sm text-gray-600">Next lesson: ${new Date(learner.next_lesson).toLocaleString()}</p>` : ''}
              </div>
              <div class="flex space-x-2">
                <button class="text-blue-600 hover:text-blue-800 px-3 py-1 text-sm border border-blue-600 rounded">
                  View Details
                </button>
                <button class="text-green-600 hover:text-green-800 px-3 py-1 text-sm border border-green-600 rounded">
                  Book Lesson
                </button>
              </div>
            </div>
          `;
          learnersList.appendChild(learnerDiv);
        });
      }
      
      // Categories are now defined at the top of the script section

      // Load and render finances data
      async function loadFinances() {
        console.log('Loading finances data...');
        await loadFinancialData();
        updateCategoryOptions();
        populateMonthlyDropdown();
      }

      // Load financial data from Supabase
      async function loadFinancialData() {
        try {
          if (!currentUser?.id) {
            console.log('No current user, using demo data');
            // Use demo data when no user is logged in
            window.allTransactions = getDemoTransactions();
            updateFinancialSummary();
            renderTransactionsTable();
            return;
          }

          console.log('Loading transactions for instructor:', currentUser.id);
          const { data: transactions, error } = await supabase
            .from('transactions')
            .select('*')
            .eq('instructor_id', currentUser.id)
            .order('date', { ascending: false });

          if (error) {
            console.error('Error loading transactions:', error);
            console.log('Falling back to demo data due to error');
            // Fallback to demo data on error
            window.allTransactions = getDemoTransactions();
          } else {
            console.log('Loaded transactions from Supabase:', transactions?.length || 0);
            // Prioritize real Supabase data, use demo data only if completely empty
            if (transactions && transactions.length > 0) {
              console.log('Using real Supabase transaction data');
              window.allTransactions = transactions;
            } else {
              console.log('No transactions in database, using demo data');
              window.allTransactions = getDemoTransactions();
            }
          }

          updateFinancialSummary();
          renderTransactionsTable();
        } catch (error) {
          console.error('Error loading financial data:', error);
          console.log('Falling back to demo data due to exception');
          // Fallback to demo data on exception
          window.allTransactions = getDemoTransactions();
          updateFinancialSummary();
          renderTransactionsTable();
        }
      }

      // Demo transactions data
      function getDemoTransactions() {
        const currentDate = new Date();
        const currentMonth = currentDate.toISOString().slice(0, 7);
        const lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1).toISOString().slice(0, 7);
        
        return [
          // Income transactions (lesson payments)
          {
            id: 'demo-1',
            type: 'income',
            category: 'Lesson Payment',
            amount: 35.00,
            description: 'Emma Thompson - Standard Lesson',
            date: `${currentMonth}-15`,
            tax_category: 'business'
          },
          {
            id: 'demo-2',
            type: 'income',
            category: 'Lesson Payment',
            amount: 70.00,
            description: 'James Wilson - 2 Hour Block',
            date: `${currentMonth}-14`,
            tax_category: 'business'
          },
          {
            id: 'demo-3',
            type: 'income',
            category: 'Lesson Payment',
            amount: 35.00,
            description: 'Sarah Davis - Standard Lesson',
            date: `${currentMonth}-13`,
            tax_category: 'business'
          },
          {
            id: 'demo-4',
            type: 'income',
            category: 'Intensive Course',
            amount: 350.00,
            description: 'Michael Brown - 10 Hour Package',
            date: `${currentMonth}-10`,
            tax_category: 'business'
          },
          {
            id: 'demo-5',
            type: 'income',
            category: 'Theory Support',
            amount: 25.00,
            description: 'Lisa Smith - Theory Mock Test',
            date: `${currentMonth}-08`,
            tax_category: 'business'
          },
          // Expense transactions
          {
            id: 'demo-6',
            type: 'expense',
            category: 'Fuel',
            amount: 45.50,
            description: 'Shell Petrol Station',
            date: `${currentMonth}-12`,
            tax_category: 'business'
          },
          {
            id: 'demo-7',
            type: 'expense',
            category: 'Vehicle Maintenance',
            amount: 89.99,
            description: 'Kwik Fit - Oil Change & Filter',
            date: `${currentMonth}-05`,
            tax_category: 'business'
          },
          {
            id: 'demo-8',
            type: 'expense',
            category: 'Insurance',
            amount: 125.00,
            description: 'Admiral Insurance - Monthly Premium',
            date: `${currentMonth}-01`,
            tax_category: 'business'
          },
          {
            id: 'demo-9',
            type: 'expense',
            category: 'Professional Development',
            amount: 75.00,
            description: 'DVSA Standards Check',
            date: `${lastMonth}-28`,
            tax_category: 'business'
          },
          {
            id: 'demo-10',
            type: 'expense',
            category: 'Equipment',
            amount: 32.99,
            description: 'Learner L Plates & Mirror',
            date: `${lastMonth}-25`,
            tax_category: 'business'
          },
          // Previous month data
          {
            id: 'demo-11',
            type: 'income',
            category: 'Lesson Payment',
            amount: 315.00,
            description: 'Various lesson payments',
            date: `${lastMonth}-20`,
            tax_category: 'business'
          },
          {
            id: 'demo-12',
            type: 'expense',
            category: 'Fuel',
            amount: 52.30,
            description: 'BP Petrol Station',
            date: `${lastMonth}-15`,
            tax_category: 'business'
          }
        ];
      }
      
      function renderRecentPayments(payments) {
        const paymentsList = document.getElementById('recent-payments');
        const paymentsContainer = paymentsList.querySelector('.space-y-4') || paymentsList;
        
        // Clear existing content except the title
        const title = paymentsList.querySelector('h4');
        paymentsList.innerHTML = '';
        if (title) paymentsList.appendChild(title);
        
        payments.forEach(payment => {
          const paymentDiv = document.createElement('div');
          paymentDiv.className = 'border border-gray-200 rounded-lg p-4';
          
          const statusColor = payment.status === 'Paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
          
          paymentDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <h5 class="font-medium text-gray-900">${payment.learner_name}</h5>
                <p class="text-sm text-gray-600">Lesson: ${new Date(payment.lesson_date).toLocaleDateString()}</p>
                <p class="text-sm text-gray-600">Payment Date: ${new Date(payment.date).toLocaleDateString()}</p>
              </div>
              <div class="text-right">
                <p class="font-medium text-gray-900">£${payment.amount.toFixed(2)}</p>
                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${payment.status}</span>
              </div>
            </div>
          `;
          paymentsList.appendChild(paymentDiv);
         });
       }
       
       // Functions for managing vehicles, qualifications, and areas
       async function removeVehicle(vehicleId) {
         try {
           const { error } = await supabase
             .from('vehicles')
             .delete()
             .eq('id', vehicleId);

           if (error) {
             console.error('Error removing vehicle:', error);
             alert('Failed to remove vehicle: ' + error.message);
             return;
           }

           vehicles = vehicles.filter(v => v.id !== vehicleId);
           renderVehicles();
           alert('Vehicle removed successfully!');
         } catch (error) {
           console.error('Error removing vehicle:', error);
           alert('Failed to remove vehicle');
         }
       }
       
       async function removeQualification(qualificationId) {
         try {
           const { error } = await supabase
             .from('qualifications')
             .delete()
             .eq('id', qualificationId);

           if (error) {
             console.error('Error removing qualification:', error);
             alert('Failed to remove qualification: ' + error.message);
             return;
           }

           qualifications = qualifications.filter(q => q.id !== qualificationId);
           renderQualifications();
           alert('Qualification removed successfully!');
         } catch (error) {
           console.error('Error removing qualification:', error);
           alert('Failed to remove qualification');
         }
       }
       
       async function removeArea(areaId) {
         try {
           const { error } = await supabase
             .from('areas')
             .delete()
             .eq('id', areaId);

           if (error) {
             console.error('Error removing area:', error);
             alert('Failed to remove area: ' + error.message);
             return;
           }

           areas = areas.filter(a => a.id !== areaId);
           renderAreas();
           alert('Area removed successfully!');
         } catch (error) {
           console.error('Error removing area:', error);
           alert('Failed to remove area');
         }
       }
       
       function addVehicle() {
         if (!currentUser?.id) {
           alert('No user session found');
           return;
         }
         showAddVehicleModal();
       }

       function showAddVehicleModal() {
         document.getElementById('addVehicleModal').classList.remove('hidden');
       }

       function hideAddVehicleModal() {
         document.getElementById('addVehicleModal').classList.add('hidden');
         document.getElementById('addVehicleForm').reset();
       }

       async function handleAddVehicle(event) {
         event.preventDefault();
         
         try {
           if (!currentUser?.id) {
             alert('No user session found');
             return;
           }

           const formData = new FormData(event.target);
           const vehicleData = {
             instructor_id: currentUser.id,
             make: formData.get('make'),
             model: formData.get('model'),
             year: formData.get('year') ? parseInt(formData.get('year')) : null,
             registration: formData.get('registration'),
             fuel_type: formData.get('fuel_type'),
             transmission: formData.get('transmission'),
             insurance_expiry: formData.get('insurance_expiry') || null,
             mot_expiry: formData.get('mot_expiry') || null,
             road_tax_expiry: formData.get('road_tax_expiry') || null
           };

           const { data, error } = await supabase
             .from('vehicles')
             .insert([vehicleData])
             .select()
             .single();

           if (error) {
             console.error('Error adding vehicle:', error);
             alert('Failed to add vehicle: ' + error.message);
             return;
           }

           vehicles.push(data);
           renderVehicles();
           hideAddVehicleModal();
           alert('Vehicle added successfully!');
         } catch (error) {
           console.error('Error in handleAddVehicle:', error);
           alert('Failed to add vehicle');
         }
       }
       
       function addQualification() {
         if (!currentUser?.id) {
           alert('No user session found');
           return;
         }
         showAddQualificationModal();
       }

       function showAddQualificationModal() {
         document.getElementById('addQualificationModal').classList.remove('hidden');
       }

       function hideAddQualificationModal() {
         document.getElementById('addQualificationModal').classList.add('hidden');
         document.getElementById('addQualificationForm').reset();
       }

       async function handleAddQualification(event) {
         event.preventDefault();
         
         try {
           if (!currentUser?.id) {
             alert('No user session found');
             return;
           }

           const formData = new FormData(event.target);
           const qualificationData = {
             instructor_id: currentUser.id,
             qualification_type: formData.get('qualification_type'),
             qualification_name: formData.get('qualification_name'),
             issuing_body: formData.get('issuing_body'),
             issue_date: formData.get('issue_date') || null,
             expiry_date: formData.get('expiry_date') || null,
             reference_number: formData.get('reference_number')
           };

           const { data, error } = await supabase
             .from('qualifications')
             .insert([qualificationData])
             .select()
             .single();

           if (error) {
             console.error('Error adding qualification:', error);
             alert('Failed to add qualification: ' + error.message);
             return;
           }

           qualifications.push(data);
           renderQualifications();
           hideAddQualificationModal();
           alert('Qualification added successfully!');
         } catch (error) {
           console.error('Error in handleAddQualification:', error);
           alert('Failed to add qualification');
         }
       }
       
       function addArea() {
         if (!currentUser?.id) {
           alert('No user session found');
           return;
         }
         showAddAreaModal();
       }

       function showAddAreaModal() {
         document.getElementById('addAreaModal').classList.remove('hidden');
         
         // Set up postcode validation
         const postcodeInput = document.getElementById('areaPostcode');
         const feedbackElement = document.getElementById('areaPostcodeFeedback');
         setupPostcodeValidation(postcodeInput, feedbackElement);
       }

       function hideAddAreaModal() {
         document.getElementById('addAreaModal').classList.add('hidden');
         document.getElementById('addAreaForm').reset();
       }

       async function handleAddArea(event) {
         event.preventDefault();
         
         try {
           if (!currentUser?.id) {
             alert('No user session found');
             return;
           }

           const formData = new FormData(event.target);
           const areaData = {
             instructor_id: currentUser.id,
             area_name: formData.get('area_name'),
             postcode: formData.get('postcode'),
             additional_charge: parseFloat(formData.get('additional_charge')) || 0.00
           };

           const { data, error } = await supabase
             .from('areas')
             .insert([areaData])
             .select()
             .single();

           if (error) {
             console.error('Error adding area:', error);
             alert('Failed to add area: ' + error.message);
             return;
           }

           areas.push(data);
           renderAreas();
           hideAddAreaModal();
           alert('Area added successfully!');
         } catch (error) {
           console.error('Error in handleAddArea:', error);
           alert('Failed to add area');
         }
       }
      
      // Save functions for each section
      async function savePersonalDetails() {
        try {
          if (!currentUser?.id) {
            alert('No user session found');
            return;
          }

          const form = document.getElementById('personal-details-form');
          const formData = new FormData(form);
          
          const updateData = {
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            full_name: `${formData.get('first_name')} ${formData.get('last_name')}`,
            email: formData.get('email'),
            phone: formData.get('phone'),
            address_line_1: formData.get('address_line1'),
            address_line_2: formData.get('address_line2'),
            city: formData.get('city'),
            postcode: formData.get('postcode'),
            date_of_birth: formData.get('date_of_birth'),
            emergency_contact_name: formData.get('emergency_contact_name'),
            emergency_contact_phone: formData.get('emergency_contact_phone')
          };
          
          const { data, error } = await supabase
            .from('instructors')
            .update(updateData)
            .eq('id', currentUser.id);

          if (error) {
            console.error('Error saving personal details:', error);
            alert('Failed to save personal details: ' + error.message);
            return;
          }
          
          console.log('Personal details saved successfully:', data);
          alert('Personal details saved successfully!');
          
        } catch (error) {
          console.error('Error saving personal details:', error);
          alert('Failed to save personal details');
        }
      }
      
      async function saveVehicleDetails() {
        try {
          console.log('Vehicle details are saved automatically when added/removed');
          alert('Vehicle details saved successfully!');
        } catch (error) {
          console.error('Error saving vehicle details:', error);
          alert('Failed to save vehicle details');
        }
      }
      
      async function saveQualificationDetails() {
        try {
          console.log('Qualification details are saved automatically when added/removed');
          alert('Qualification details saved successfully!');
        } catch (error) {
          console.error('Error saving qualification details:', error);
          alert('Failed to save qualification details');
        }
      }
      
      async function saveAreasDetails() {
        try {
          console.log('Areas details are saved automatically when added/removed');
          alert('Areas details saved successfully!');
        } catch (error) {
          console.error('Error saving areas details:', error);
          alert('Failed to save areas details');
        }
      }
      
      async function savePreferencesDetails() {
        try {
          if (!currentUser?.id) {
            alert('No user session found');
            return;
          }

          console.log('Saving preferences details...');
          
          // Get form data
          const formData = new FormData(document.querySelector('#preferences-tab form'));
          
          // Build working days object
          const workingDaysArray = formData.getAll('working_days');
          const workingDaysObj = {
            monday: workingDaysArray.includes('monday'),
            tuesday: workingDaysArray.includes('tuesday'),
            wednesday: workingDaysArray.includes('wednesday'),
            thursday: workingDaysArray.includes('thursday'),
            friday: workingDaysArray.includes('friday'),
            saturday: workingDaysArray.includes('saturday'),
            sunday: workingDaysArray.includes('sunday')
          };
          
          const preferencesData = {
            instructor_id: currentUser.id,
            max_pupils: parseInt(formData.get('max_pupils')) || 20,
            standard_lesson_price: parseFloat(formData.get('lesson_price')) || 35.00,
            intensive_lesson_price: parseFloat(formData.get('intensive_price')) || 280.00,
            working_hours_start: formData.get('start_time') + ':00',
            working_hours_end: formData.get('end_time') + ':00',
            working_days: workingDaysObj
          };
          
          console.log('Preferences data:', preferencesData);
          
          const { data, error } = await supabase
            .from('preferences')
            .upsert([preferencesData], { onConflict: 'instructor_id' });

          if (error) {
            console.error('Error saving preferences:', error);
            alert('Failed to save preferences: ' + error.message);
            return;
          }
          
          console.log('Preferences saved successfully:', data);
          alert('Preferences saved successfully!');
          
          // Refresh calendar to apply new working hours
          renderCalendar();
          
        } catch (error) {
          console.error('Error saving preferences:', error);
          alert('Failed to save preferences');
        }
      }

      // Mobile menu functionality
      function initMobileMenu() {
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const sidebar = document.getElementById('sidebar');
        
        if (mobileMenuBtn && mobileMenuOverlay && sidebar) {
          // Toggle mobile menu
          mobileMenuBtn.addEventListener('click', () => {
            mobileMenuOverlay.classList.remove('hidden');
            sidebar.classList.remove('-translate-x-full');
          });
          
          // Close mobile menu when clicking overlay
          mobileMenuOverlay.addEventListener('click', (e) => {
            if (e.target === mobileMenuOverlay) {
              mobileMenuOverlay.classList.add('hidden');
              sidebar.classList.add('-translate-x-full');
            }
          });
          
          // Close mobile menu when clicking navigation links
          const navLinks = sidebar.querySelectorAll('a, button');
          navLinks.forEach(link => {
            link.addEventListener('click', () => {
              mobileMenuOverlay.classList.add('hidden');
              sidebar.classList.add('-translate-x-full');
            });
          });
        }
      }

      // Event listeners
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing calendar...');
        
        // Initialize mobile menu
        initMobileMenu();
        
        // Add window resize listener for responsive calendar
        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            if (document.getElementById('calendar-page').style.display !== 'none') {
              renderCalendar();
            }
          }, 250);
        });
        
        // Navigation buttons
        document.getElementById('today-btn').addEventListener('click', () => {
          console.log('Today button clicked');
          currentDate = dayjs();
          console.log('Current date set to:', currentDate.format('YYYY-MM-DD'));
          renderCalendar();
        });

        document.getElementById('prev-week-btn').addEventListener('click', () => {
          console.log('Previous week button clicked');
          currentDate = currentDate.subtract(1, 'week');
          console.log('Current date set to:', currentDate.format('YYYY-MM-DD'));
          renderCalendar();
        });

        document.getElementById('next-week-btn').addEventListener('click', () => {
          console.log('Next week button clicked');
          currentDate = currentDate.add(1, 'week');
          console.log('Current date set to:', currentDate.format('YYYY-MM-DD'));
          renderCalendar();
        });

        // Close modal on backdrop click
        document.getElementById('lesson-modal').addEventListener('click', (e) => {
          if (e.target.id === 'lesson-modal') {
            document.getElementById('lesson-modal').classList.add('hidden');
          }
        });
        
        // Financial modals event listeners
        const addTransactionModal = document.getElementById('addTransactionModal');
        const monthlyBreakdownModal = document.getElementById('monthlyBreakdownModal');
        
        if (addTransactionModal) {
          addTransactionModal.addEventListener('click', (e) => {
            if (e.target.id === 'addTransactionModal') {
              hideAddTransactionModal();
            }
          });
          
          const cancelBtn = addTransactionModal.querySelector('[onclick="hideAddTransactionModal()"]');
          if (cancelBtn) {
            cancelBtn.addEventListener('click', hideAddTransactionModal);
          }
        }
        
        if (monthlyBreakdownModal) {
          monthlyBreakdownModal.addEventListener('click', (e) => {
            if (e.target.id === 'monthlyBreakdownModal') {
              hideMonthlyBreakdown();
            }
          });
          
          const closeBtn = monthlyBreakdownModal.querySelector('[onclick="hideMonthlyBreakdown()"]');
          if (closeBtn) {
            closeBtn.addEventListener('click', hideMonthlyBreakdown);
          }
        }

        // Add Learner Modal event listeners
        const addLearnerModal = document.getElementById('addLearnerModal');
        if (addLearnerModal) {
          addLearnerModal.addEventListener('click', (e) => {
            if (e.target.id === 'addLearnerModal') {
              hideAddLearnerModal();
            }
          });
        }
        
        // Add Lesson Modal event listeners
        const addLessonModal = document.getElementById('addLessonModal');
        if (addLessonModal) {
          addLessonModal.addEventListener('click', (e) => {
            if (e.target.id === 'addLessonModal') {
              hideAddLessonModal();
            }
          });
        }
        
        // Form submissions
        const addLearnerForm = document.getElementById('addLearnerForm');
        if (addLearnerForm) {
          addLearnerForm.addEventListener('submit', handleAddLearner);
        }
        
        const addLessonForm = document.getElementById('addLessonForm');
        if (addLessonForm) {
          addLessonForm.addEventListener('submit', handleAddLesson);
        }
        
        const preferencesForm = document.getElementById('preferences-form');
        if (preferencesForm) {
          preferencesForm.addEventListener('submit', function(e) {
            e.preventDefault();
            savePreferencesDetails();
          });
        }
        
        // Handle lesson type change
        const lessonTypeSelect = document.getElementById('lesson-type');
        if (lessonTypeSelect) {
          lessonTypeSelect.addEventListener('change', function() {
            const learnerField = document.getElementById('learner-field');
            const learnerSelect = document.getElementById('lesson-learner');
            
            if (this.value === 'unavailable') {
              learnerField.style.display = 'none';
              learnerSelect.removeAttribute('required');
            } else {
              learnerField.style.display = 'block';
              learnerSelect.setAttribute('required', 'required');
            }
          });
        }

        // Initialize icons
        lucide.createIcons();
        console.log('Icons initialized');
        
        // Check authentication first, then initialize instructor data
        checkAuthentication().then(user => {
          if (!user) return; // Will redirect to login

          // Initialize instructor data first, then load other data
          return loadInstructorData();
        }).then(() => {
          // Update UI with user info
          updateUserInterface();

          // Load preferences first, then financial and learners data
          return loadPreferences();
        }).then(() => {
          // Now load other data
          loadFinancialData();
          loadLearners();

          // Check URL fragment and show appropriate page
          const fragment = window.location.hash.substring(1); // Remove the #
          console.log('URL fragment:', fragment);
          if (fragment === 'home') {
            showPage('home');
          } else {
            // Default to calendar view
            console.log('Calling renderCalendar...');
            renderCalendar();
          }
        }).catch(error => {
          console.error('Initialization error:', error);
        });
      });
      
      // Modal functions for Add New Learner
      function showAddLearnerModal() {
        const modal = document.getElementById('addLearnerModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Set up postcode validation for learner form
        const postcodeInput = document.getElementById('learner-postcode');
        const feedbackElement = document.getElementById('learnerPostcodeFeedback');
        setupPostcodeValidation(postcodeInput, feedbackElement);
      }
      
      function hideAddLearnerModal() {
        const modal = document.getElementById('addLearnerModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        // Reset form
        document.getElementById('addLearnerForm').reset();
      }
      
      // Modal functions for Add Lesson
      function showAddLessonModal(date = null, time = null) {
        const modal = document.getElementById('addLessonModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Pre-fill date and time if provided
        if (date) {
          document.getElementById('lesson-date').value = date;
        }
        if (time) {
          document.getElementById('lesson-start-time').value = time;
        }
        
        // Load learners for the dropdown
        loadLearnersForLessonForm();
      }
      
      function hideAddLessonModal() {
        const modal = document.getElementById('addLessonModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        // Reset form
        document.getElementById('addLessonForm').reset();
      }
      
      // Handle Add Learner form submission
      async function handleAddLearner(e) {
        e.preventDefault();
        
        if (!currentUser?.id) {
          alert('No user session found');
          return;
        }
        
        const formData = new FormData(e.target);
        const firstName = formData.get('first_name');
        const lastName = formData.get('last_name');
        
        const learnerData = {
          instructor_id: currentUser.id,
          first_name: firstName,
          last_name: lastName,
          full_name: `${firstName} ${lastName}`,
          name: `${firstName} ${lastName}`, // For backward compatibility
          email: formData.get('email'),
          phone: formData.get('phone'),
          date_of_birth: formData.get('date_of_birth') || null,
          provisional_license_number: formData.get('provisional_license_number') || null,
          address: formData.get('address') || null,
          notes: formData.get('notes') || null
        };
        
        try {
          // Insert into Supabase
          const { data, error } = await supabase
            .from('pupils')
            .insert([learnerData])
            .select();
          
          if (error) {
            console.error('Error adding learner:', error);
            alert('Failed to add learner: ' + error.message);
            return;
          }
          
          console.log('Learner added successfully:', data);
          alert('Learner added successfully!');
          hideAddLearnerModal();
          
          // Refresh learners list if on learners page
          if (document.getElementById('learners-page').style.display !== 'none') {
            loadLearners();
          }
          
        } catch (error) {
          console.error('Error adding learner:', error);
          alert('Failed to add learner. Please try again.');
        }
      }
      
      // Handle Add Lesson form submission
      async function handleAddLesson(e) {
        e.preventDefault();
        
        if (!currentUser?.id) {
          alert('No user session found');
          return;
        }
        
        const formData = new FormData(e.target);
        const lessonType = formData.get('lesson_type') || 'lesson';
        
        const lessonData = {
          lesson_type: lessonType,
          instructor_id: currentUser.id, // Always use current instructor
          pupil_id: lessonType === 'unavailable' ? null : formData.get('pupil_id'),
          lesson_date: formData.get('lesson_date'),
          start_time: formData.get('start_time'),
          duration: parseInt(formData.get('duration_minutes')),
          pickup_address: lessonType === 'unavailable' ? null : (formData.get('pickup_address') || null),
          lesson_notes: formData.get('notes') || null,
          status: lessonType === 'unavailable' ? 'unavailable' : 'scheduled'
        };
        
        try {
          // Insert into Supabase
          const { data, error } = await supabase
            .from('lessons')
            .insert([lessonData])
            .select();
          
          if (error) {
            console.error('Error adding lesson:', error);
            alert('Failed to add lesson: ' + error.message);
            return;
          }
          
          console.log('Lesson added successfully:', data);
          alert('Lesson added successfully!');
          hideAddLessonModal();
          
          // Refresh calendar
          renderCalendar();
          
        } catch (error) {
          console.error('Error adding lesson:', error);
          alert('Failed to add lesson. Please try again.');
        }
      }
      
      // Load learners for lesson form dropdown
      async function loadLearnersForLessonForm() {
        try {
          if (!currentUser?.id) {
            return;
          }

          const { data: learners, error } = await supabase
            .from('pupils')
            .select('id, first_name, last_name')
            .eq('instructor_id', currentUser.id)
            .order('first_name');
          
          if (error) {
            console.error('Error loading learners:', error);
            return;
          }
          
          const select = document.getElementById('lesson-learner');
          // Clear existing options except the first one
          select.innerHTML = '<option value="">Select a learner...</option>';
          
          learners.forEach(learner => {
            const option = document.createElement('option');
            option.value = learner.id;
            option.textContent = `${learner.first_name} ${learner.last_name}`;
            select.appendChild(option);
          });
          
        } catch (error) {
          console.error('Error loading learners:', error);
        }
      }
      
      // Add calendar click functionality
      function handleCalendarCellClick(date, hour) {
        const clickedDate = dayjs(date).format('YYYY-MM-DD');
        const clickedTime = hour ? `${hour.toString().padStart(2, '0')}:00` : '09:00';
        
        // Check if the clicked day is a working day
        const dayName = dayjs(date).format('dddd').toLowerCase();
        const workingDayCheckboxes = document.querySelectorAll('input[name="working_days"]:checked');
        const workingDays = Array.from(workingDayCheckboxes).map(cb => cb.value);
        
        if (!workingDays.includes(dayName)) {
          alert('Lessons are not available on this day. Please check your working days in preferences.');
          return;
        }
        
        // Show add lesson modal with pre-filled date and time
        showAddLessonModal(clickedDate, clickedTime);
      }
      
      // Export data function
      function exportData() {
        // Simple CSV export functionality
        const data = [
          ['Date', 'Student', 'Lesson Type', 'Duration', 'Payment'],
          ['2024-01-15', 'Sarah Johnson', 'Manual', '2 hours', '£60'],
          ['2024-01-15', 'Mike Peters', 'Automatic', '1 hour', '£30'],
          ['2024-01-15', 'Emma Wilson', 'Test Prep', '2 hours', '£60'],
          ['2024-01-14', 'James Brown', 'Manual', '1 hour', '£30'],
          ['2024-01-14', 'Lucy Davis', 'Automatic', '2 hours', '£60']
        ];
        
        const csvContent = data.map(row => row.join(',')).join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'adi-diary-export.csv';
        a.click();
        window.URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
